<html>

<head>

<title>Linked charts - Labels and legend</title>

<link rel="stylesheet" href="src/prism.css">
<script src = "src/prism.js"></script>

</head>

<body>

<h1>Linked charts</h1>

<h2>Labels and legend</h2>

<p>In this example, we will further fine tune our plots, to make them more easy to read. We will add labels to axes, 
titles to plots, rename axes ticks. One could have already noticed that setting <tt>colourValue</tt> property automatically 
generates a legend. Here, we will show how to manipulate this legend and how to create legends manually.</p>

<link rel = "stylesheet" type = "text/css" href = "lib/linked-charts.css">
<script src = "lib/linked-charts.min.js"></script>
<script src = "src/inputdata.js"></script>

<table><tr>
  <td id="heatmap" valign="top"></td>
  <td id="scatterplot" valign="top"></td>
</tr></table>

<script>

inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);
var drugs = Object.keys(inputData.RTG),
  cellLines = Object.keys(inputData.RTG[drugs[0]]);

var selDrugs = [drugs[0], drugs[1]],
  selCellLine = cellLines[0];

var heatmap = lc.heatmapChart()
  .rowIds( drugs )
  .colIds( drugs )
  .title("Drug-drug correlation")
  .colourRange( [ -1, 1 ] )
  .palette( function( val ) { return d3.interpolateRdBu( 1 - val ); } )
  .value( function( rowId, colId ) {  
    var rowValues = cellLines.map(function(e) {
        return inputData.RTG[rowId][e].avInh;
      }),
      colValues = cellLines.map(function(e) {
        return inputData.RTG[colId][e].avInh;
      });
    return lc.pearsonCorr( rowValues, colValues ); 
   })
  .on_click( function( rowId, colId ) {
     selDrugs = [rowId, colId]
     scatterplot.update();
     curveFit.update();
  })
  .place( "#heatmap" );

heatmap.cluster( "Row" )
  .cluster( "Col" );

var get_curve = function( drug, cellLine, x ){
  var max = inputData.RTG[drug][cellLine].max,
    min = inputData.RTG[drug][cellLine].min,
    IC50 = inputData.RTG[drug][cellLine].IC50,
    slope = inputData.RTG[drug][cellLine].Slope,
    minConc = inputData.RTG[drug][cellLine].minConc;
      
  return min + (max - min)/
    (1 + Math.pow(10, -(x - Math.log10(IC50/minConc)) * slope));
}

var scatterplot = lc.scatterChart("Total curvefitting error")
  .width( 375 )
  .height( 300 )
  .dataIds( cellLines )
  .x( function( k ) { return inputData.RTG[selDrugs[0]][k].avInh } )
  .y( function( k ) { return inputData.RTG[selDrugs[1]][k].avInh } )
  .labelX(function() {return selDrugs[0]})
  .labelY(function() {return selDrugs[1]})
  .title("Average inhibition")
  .domainX([-10, 50])
  .domainY([-10, 50])
  .palette( ["green", "yellow","red"] )
  .colourValue( function( k ) {
    var res = 0;
    for( var x = 0; x < 5; x++ )
      for( var l = 0; l < 2; l++ )
        res += Math.pow( get_curve( selDrugs[l], k, x ) - 
                    inputData.RTG[selDrugs[l]][k]["D" + (x + 1)], 2 ); 
    res = Math.sqrt( res );
    return res;
  })
  .colourRange( [ 0, 30 ] ) 
  .on_click( function( k ) {
    scatterplot.svg.selectAll(".clicked").classed("clicked", false);
    d3.select(this).classed("clicked", true);
    selCellLine = k;
    curveFit.update();
  });
lc.lineChart("line", scatterplot)
  .npoints(1)
  .lineFun( function( k, x ){
    return x;
  })
  .place( "#scatterplot" );

var curveFit = lc.scatterChart( "points" )
  .width( 375 )
  .height( 200 )
  .npoints( 10 )
  .title(function() {return selCellLine;})
  .labelX("Drug concentration")
  .labelY("Inhibition")
  .domainY([-25, 100])
  .ticksX(function() {
    var ticks = [d3.range(5), 
      d3.range(5).map(function(e) {
        return inputData.RTG[selDrugs[0]][selCellLine].minConc * 
                Math.pow(10, e)
      }),
      d3.range(5).map(function(e) {
        return inputData.RTG[selDrugs[1]][selCellLine].minConc * 
                Math.pow(10, e)
      })];
    ticks.colour = ["blue", "red"];
    return ticks;
  })
  .x( function( k ) {
    return k % 5;
  } )
  .y( function( k ) {
    var ind = Math.floor( k / 5 );
    return inputData.RTG[selDrugs[ind]][selCellLine]["D" + (k % 5 + 1)];
  })
  .colour( function( k ) {
    return k > 4 ? "red" : "blue";
  } );
lc.lineChart("lines", curveFit)
  .npoints(2)
  .lineFun( function( k, x ) {
    return get_curve( selDrugs[k], selCellLine, x );
  })
  .colour(function( k ){
    return k == 0 ? "blue" : "red";
  })
  .place( "#scatterplot" );
curveFit.legend.add(function() {return [selDrugs, ["blue", "red"]];}, 
                      "colour", "Drugs");  


</script>

<p style = 'background: #daeaff; padding: 10px; width: 50%;'>Note that on both charts zooming is possible (double-click to show the entire chart). 
To order rows or columns of the heatmap according to the values in some column or row one can click on the corresponding label on the heatmap. 
This default behaviour can be changed by user.</p>

<div id = "navPanel"></div>
<script src = "src/navigation.js"></script>
<script>
  showNavigationPanel(d3.select("#navPanel"), 3);
</script>

<br>
<br>
<br>
<h2>The code for the example</h2>

<p>A user of our framework can create apps with very little code. The following code is not complete, since some lines that were
explained in the previous example are omitted for the sake of simplicity. <span style = "color: #b44; font-weight: bold;"
onclick="window.open('labelsAndLegend_code.html', 'newwindow', 'width=800, height=800');">Here</span> one can find the complete code for this example.</p>

<table><tr><td valign="top">
<pre class = "language-javascript">
<x-expl id="heatmap"></x-expl><code>var heatmap = lc.heatmapChart()</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="title"></x-expl><code>  .title("Drug-drug correlation")</code>
<x-expl id="palette"></x-expl><code>  .palette( function( val ) { return d3.interpolateRdBu( 1 - val ); } )</code>
<x-expl id="heatmap"></x-expl><code>  .place( "#heatmap" );</code>

<x-expl id="skip"></x-expl><code>...</code>

<x-expl id="scatter"></x-expl><code>var scatterplot = lc.scatterChart( "Total curvefitting error" )</code>
<x-expl id="width"></x-expl><code>  .width( 375 )</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="label"></x-expl><code>  .labelX(function() {return selDrugs[0]})</code>
<x-expl id="label"></x-expl><code>  .labelY(function() {return selDrugs[1]})</code>
<x-expl id="title"></x-expl><code>  .title("Average inhibition")</code>
<x-expl id="domain"></x-expl><code>  .domainX([-10, 50])</code>
<x-expl id="domain"></x-expl><code>  .domainY([-10, 50]);</code>
<x-expl id="line"></x-expl><code>lc.lineChart("line", scatterplot)</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="scatter"></x-expl><code>  .place( "#scatterplot" );</code>

<x-expl id="curveFit"></x-expl><code>var curveFit = lc.scatterChart( "points" )</code>
<x-expl id="width"></x-expl><code>  .width( 375 )</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="title"></x-expl><code>  .title(function() {return selCellLine;})</code>
<x-expl id="label"></x-expl><code>  .labelX("Drug concentration")</code>
<x-expl id="label"></x-expl><code>  .labelY("Inhibition")</code>
<x-expl id="domain"></x-expl><code>  .domainY([-25, 100])</code>
<x-expl id="ticks"></x-expl><code>  .ticksX(function() {</code>
<x-expl id="ticksArray"></x-expl><code>    var ticks = [d3.range(5), </code>
<x-expl id="ticksArray"></x-expl><code>      d3.range(5).map(function(e) {</code>
<x-expl id="ticksArray"></x-expl><code>        return inputData.RTG[selDrugs[0]][selCellLine].minConc * </code>
<x-expl id="ticksArray"></x-expl><code>                Math.pow(10, e)</code>
<x-expl id="ticksArray"></x-expl><code>      }),</code>
<x-expl id="ticksArray"></x-expl><code>      d3.range(5).map(function(e) {</code>
<x-expl id="ticksArray"></x-expl><code>        return inputData.RTG[selDrugs[1]][selCellLine].minConc * </code>
<x-expl id="ticksArray"></x-expl><code>                Math.pow(10, e)</code>
<x-expl id="ticksArray"></x-expl><code>      })];</code>
<x-expl id="ticksColour"></x-expl><code>    ticks.colour = ["blue", "red"];</code>
<x-expl id="ticks"></x-expl><code>    return ticks;</code>
<x-expl id="ticks"></x-expl><code>  });</code>
<x-expl id="line"></x-expl><code>lc.lineChart("lines", curveFit)</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="curveFit"></x-expl><code>  .place( "#scatterplot" );</code></pre>
<x-expl id="legend"></x-expl><code>curveFit.legend.add(function() {return [selDrugs, ["blue", "red"]];}, </code>
<x-expl id="legend"></x-expl><code>                      "colour", "Drugs");  </code>
</td>
<td valign="top" style="padding-left:20px">

<style>
div.expl {
   display: none;
   position: absolute;
   background: #EBBCD8;
   width: 40%;
   padding: 10px;
}
</style>

<p style="background:#f0fff0; padding:10px"><i>Click on all the yellow bubbles (<img height="10pt" src="src/bubble_yellow.svg">),
going from top to bottom, to see explanations of the code.</i></p>
<br>

<div class="expl" id="heatmap">
<p>The heatmap is set almost exactly as it was done in previous examples, except for the two properties: <tt>palette</tt> 
and <tt>title</tt>. So here, all other properties were omitted for the sake of simplisity</p>
</div>

<div class="expl" id="skip">
<p>Some lines of code, whose functionality had been already described in previous examples, were omitted 
for the sake of simplicity. <span style = "color: #44b; font-weight: bold;"
 onclick="window.open('labelsAndLeged_code.html', 'newwindow', 'width=800, height=800');">
Here</span>, you can find the complete working code.</p>
</div>

<div class="expl" id="title">
<p>Here, we define a title of the plot. In this example, two plots has fixed titles, while the title of the curvefitting 
plot changes, indicating what cell line has been selected. So as any interactively changing property this title should 
be defined via function, otherwise only the current value of <tt>selCellLine</tt> variable will be saved as a title.</p>
</div>

<div class="expl" id="palette">
<p>As a palette for heatmaps one can use not only d3 interpolators, but any function that takes values from 0 to 1 as 
arguments and returns colours. So here we define our own function based on a d3 interpolater to make our heatmap more 
traditionally looking. Now we want high correlation to be shown as red and low correlation to be blue.</p>
</div>

<div class="expl" id="scatter">
<p>Initializing and placing a correlation scatter plot and a diogonal line. Automatically generated legend takes the 
name of the layer as a title, so one way to rename the legend title is by changing the layer ID, as it has been done 
here. Another option is to use <tt>chart.legend.rename(<i>oldName, newName</i>)</tt> function.</p>
</div>

<div class="expl" id="width">
<p>A default width of a plot legend is 75px (can be changed by setting <tt>width</tt> of the legend) and the width of the
plot is changed accordingly once a legend has been added. So in this example we increase the width of both plots to 
leave space for a legend.</p>
</div>

<div class="expl" id="label">
<p>Here, we set labels for X and Y axes.</p>
</div>

<div class="expl" id="domain">
<p>Here, we fix domains for X and Y axes. By default, domaines are defined to fit current data, but if we want to compare 
different sets of data, it may be useful to fix scales to encompass all available data. Note, that setting a domain doesn't 
prohibit zooming in and out.</p>
</div>

<div class="expl" id="line">
<p>Here, the lines are added to the plots the same way it has been done in the previous example.</p>
</div>

<div class="expl" id="curveFit">
<p>Here, we initialize and place the a plot to show the curvefits and inhibition values for all individual concentrations.</p>
</div>

<div class="expl" id="ticks">
<p>Here, we set the tick labels to be used instead of default ones, generated by d3.axis. The value passed to this property 
should be a set of arrays, where the first array should be a set of ticks to be displayed and all others are the labels to use 
for these values.</p>
</div>

<div class="expl" id="ticksArray">
<p>Here, we define a variable to set the ticks. In this example, we used integer values from 0 to 4 to as indeces for the five 
tested concentrations. Now we want to replace this values with the actual concentrations. We know that all the drugs were tested 
at five concentrations, each 10 times higher than the previous one. But the minimal tested concentration may differ from drug to 
drug, so it's not enough to have just one set of labels. The linked-charts library supports having multiple set of lables (try to 
find a pair of drugs with different concentrations to see how it works).</p>
</div>

<div class="expl" id="ticksColour">
<p>If we have several sets of labels, we would like to have an easy way to indicate what drug this label corresponds to. 
To this end, here we are adding an optional <tt>colour</tt> property to the ticks object. This should be an array of 
colours. Now labels for the firs drug are blue, and for the second are red.</p>
</div>

<div class="expl" id="legend">
<p>For each chart a legend is stored in a <tt>chart.legend</tt> property. By default it's empty. One can add an unlimited number of
blocks to be displayed using <tt>chart.legend.add(<i>scale, type, name, layer</i>)</tt> function.</p>
<p><tt>scale</tt> argument defines the correspondence between colour, size or shape of objects and names or numerical values. This 
argument can be a d3 scale or any other function with a defined <tt>domain</tt> property. But an easiest way to define a scale is 
just to pass to arrays with, for example, names and corresponding colours.</p>
<p><tt>type</tt> is a type scale. Currently only <tt>colour</tt> is supported, but we plan to add <tt>size</tt> and <tt>style</tt> 
types of legend.</p>
<p><tt>name</tt> is a title for the legend block.</p>
<p><tt>layer</tt> is an optional parameter to bind a block with a specific layer.</p>
</div>
</td></tr>
</table>

<script>
d3.selectAll( "x-expl" )
   .append( "img" )
      .attr( "height", "10pt" )
      .attr( "class", "bubble_icon" )
      .attr( "src", "src/bubble_yellow.svg" )
      .style( "padding-right", "15px")
      .on( "click", function() {
      	  d3.selectAll( "div.expl" )
      	     .style( "display", "none" );
          d3.selectAll( "img.bubble_icon" )
             .attr( "src", "src/bubble_yellow.svg")
      	  var tagId = d3.select(this.parentNode).attr("id");
      	  d3.select( "div.expl#" + tagId )
      	     .style( "display", "block" )
          d3.selectAll( "x-expl#" + tagId ).select("img.bubble_icon")
             .attr( "src", "src/bubble_red.svg")
       })
</script>

</body>

</html>