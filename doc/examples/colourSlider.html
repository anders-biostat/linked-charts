<html>

<head>

<title>Linked charts - Adding a colour slider</title>

<link rel="stylesheet" href="src/prism.css">
<script src = "src/prism.js"></script>

</head>

<body>

<h1>Linked charts</h1>

<h2>Adding a colour slider</h2>

<p>In this example, we will further fine tune our plots, to make them more easy to read. We will add labels to axes, 
titles to plots, rename axes ticks. One could have already noticed that setting <tt>colourValue</tt> property automatically 
generates a legend. Here, we will show how to manipulate this legend and how to create legends manually.</p>

<link rel = "stylesheet" type = "text/css" href = "lib/linked-charts.css">
<script src = "lib/linked-charts.min.js"></script>
<script src = "src/inputdata.js"></script>

<table><tr>
  <td id="heatmap" valign="top"></td>
  <td id="scatterplot" valign="top"></td>
</tr></table>

<script>

inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);
var drugs = Object.keys(inputData.RTG),
  cellLines = Object.keys(inputData.RTG[drugs[0]]);

var selDrugs = [drugs[0], drugs[1]],
  selCellLine = cellLines[0];

var heatmap = lc.heatmapChart()
  .rowIds( drugs )
  .colIds( drugs )
  .title("Drug-drug correlation")
  .colourRange( [ -1, 1 ] )
  .showLegend( false )
  .margin( {top: 100, left: 100, right: 10, bottom: 10} )
  .palette( function( val ) { return d3.interpolateRdBu( 1 - val ); } )
  .value( function( rowId, colId ) {  
    var rowValues = cellLines.map(function( e ) {
        return inputData.RTG[rowId][e].avInh;
      }),
      colValues = cellLines.map(function( e ) {
        return inputData.RTG[colId][e].avInh;
      });
    return lc.pearsonCorr( rowValues, colValues ); 
   })
  .on_click( function( rowId, colId ) {
     selDrugs = [rowId, colId]
     scatterplot.update();
     curveFit.update();
  })
  .place( "#heatmap" );

var heatmapSlider = lc.sigmoidColorSlider()
	.set_margin( {left: 100} )
	.straightColorScale( heatmap.colourScale )
	.on_change(function(){
		heatmap.updateCellColour();
	})
  .place( "#heatmap" );

heatmap.cluster( "Row" )
  .cluster( "Col" );
heatmap.colour( function( val ){
	return heatmapSlider.colourScale( val );
} );


var get_curve = function( drug, cellLine, x ){
  var max = inputData.RTG[drug][cellLine].max,
    min = inputData.RTG[drug][cellLine].min,
    IC50 = inputData.RTG[drug][cellLine].IC50,
    slope = inputData.RTG[drug][cellLine].Slope,
    minConc = inputData.RTG[drug][cellLine].minConc;
      
  return min + ( max - min )/
    (1 + Math.pow( 10, - ( x - Math.log10( IC50/minConc ) ) * slope));
}

var scatterplot = lc.scatterChart()
  .width( 300 )
  .height( 300 )
  .set_margin( {bottom: 20} )
  .showLegend( false )
  .dataIds( cellLines )
  .x( function( k ) { return inputData.RTG[selDrugs[0]][k].avInh } )
  .y( function( k ) { return inputData.RTG[selDrugs[1]][k].avInh } )
  .labelX( function() {return selDrugs[0]} )
  .labelY( function() {return selDrugs[1]} )
  .title( "Average inhibition" )
  .domainX( [-10, 50] )
  .domainY( [-10, 50] )
  .palette( ["green", "yellow","red"] )
  .colourValue( function( k ) {
    var res = 0;
    for( var x = 0; x < 5; x++ )
      for( var l = 0; l < 2; l++ )
        res += Math.pow( get_curve( selDrugs[l], k, x ) - 
                    inputData.RTG[selDrugs[l]][k]["D" + (x + 1)], 2 ); 
    res = Math.sqrt( res );
    return res;
  })
  .colourRange( [ 0, 30 ] ) 
  .on_click( function( k ) {
    scatterplot.svg.selectAll( ".clicked" )
    	.classed( "clicked", false );
    d3.select( this ).classed( "clicked", true );
    selCellLine = k;
    curveFit.update();
  });
lc.lineChart( "line", scatterplot )
  .npoints(1)
  .lineFun( function( k, x ){
    return x;
  })
  .place( "#scatterplot" );

var layer = scatterplot.get_layer( "layer0" );

var scatterSlider = lc.sigmoidColorSlider()
	.width( 300 )
	.height( 110 )
	.set_margin( {top: 50} )
	.title( "Total curvefitting error" )
	.straightColorScale( layer.colourScale )
	.on_change( function(){
		layer.updatePointStyle();
	} )
  .place( "#scatterplot" );

layer.colour(function( id ){
	return scatterSlider.colourScale( layer.get_colourValue( id ) );
});


var curveFit = lc.scatterChart( "points" )
  .width( 375 )
  .height( 200 )
  .npoints( 10 )
  .title( function() {return selCellLine;} )
  .labelX( "Drug concentration" )
  .labelY( "Inhibition" )
  .domainY( [-25, 100] )
  .ticksX( function() {
    var ticks = [d3.range( 5 ), 
      d3.range( 5 ).map( function( e ) {
        return inputData.RTG[selDrugs[0]][selCellLine].minConc * 
                Math.pow( 10, e )
      } ),
      d3.range( 5 ).map( function( e ) {
        return inputData.RTG[selDrugs[1]][selCellLine].minConc * 
                Math.pow( 10, e )
      })];
    ticks.colour = ["blue", "red"];
    return ticks;
  })
  .x( function( k ) {
    return k % 5;
  } )
  .y( function( k ) {
    var ind = Math.floor( k / 5 );
    return inputData.RTG[selDrugs[ind]][selCellLine]["D" + (k % 5 + 1)];
  })
  .colour( function( k ) {
    return k > 4 ? "red" : "blue";
  } );
lc.lineChart( "lines", curveFit )
  .npoints( 2 )
  .lineFun( function( k, x ) {
    return get_curve( selDrugs[k], selCellLine, x );
  })
  .colour(function( k ){
    return k == 0 ? "blue" : "red";
  })
  .place( "#scatterplot" );
curveFit.legend.add(function() {return [selDrugs, ["blue", "red"]];}, 
                      "colour", "Drugs");

</script>

<p style = 'background: #daeaff; padding: 10px; width: 50%;'>Note that on both charts zooming is possible (double-click to show the entire chart). 
To order rows or columns of the heatmap according to the values in some column or row one can click on the corresponding label on the heatmap. 
This default behaviour can be changed by user.</p>

<div id = "navPanel"></div>
<script src = "src/navigation.js"></script>
<script>
  showNavigationPanel(d3.select("#navPanel"), 4);
</script>

<br>
<br>
<br>
<h2>The code for the example</h2>

<p>A user of our framework can create apps with very little code. The following code is not complete, since some lines that were
explained in the previous example are omitted for the sake of simplicity. <span style = "color: #b44; font-weight: bold;"
onclick="window.open('colourSlider_code.html', 'newwindow', 'width=800, height=800');">Here</span> one can find the complete code for this example.</p>

<table><tr><td valign="top">
<pre class = "language-javascript">
<x-expl id="skip"></x-expl><code>...</code>
<x-expl id="heatmap"></x-expl><code>var heatmap = lc.heatmapChart()</code>
<x-expl id="showLegend"></x-expl><code>  .showLegend( false )</code>
<x-expl id="margin"></x-expl><code>  .margin( {top: 100, left: 100, right: 10, bottom: 10} )</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="heatmap"></x-expl><code>  .place( "#heatmap" );</code>

<x-expl id="colourSlider"></x-expl><code>var heatmapSlider = lc.sigmoidColorSlider()</code>
<x-expl id="set_margin"></x-expl><code>	.set_margin( {left: 100} )</code>
<x-expl id="straightColorScale"></x-expl><code>	.straightColorScale( heatmap.colourScale )</code>
<x-expl id="on_change"></x-expl><code>	.on_change(function(){</code>
<x-expl id="on_change"></x-expl><code>		heatmap.updateCellColour();</code>
<x-expl id="on_change"></x-expl><code>	})</code>
<x-expl id="colourSlider"></x-expl><code>  .place( "#heatmap" );</code>

<x-expl id="colour"></x-expl><code>heatmap.colour( function( val ){</code>
<x-expl id="colour"></x-expl><code>	return heatmapSlider.colourScale( val );</code>
<x-expl id="colour"></x-expl><code>} );</code>
<x-expl id="skip"></x-expl><code>...</code>

<x-expl id="scatter"></x-expl><code>var scatterplot = lc.scatterChart()</code>
<x-expl id="set_margin"></x-expl><code>  .set_margin( {bottom: 20} )</code>
<x-expl id="showLegend"></x-expl><code>  .showLegend( false )</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="on_click"></x-expl><code>  .on_click( function( k ) {</code>
<x-expl id="on_click"></x-expl><code>    scatterplot.svg.selectAll( ".clicked" )</code>
<x-expl id="on_click"></x-expl><code>    	.classed( "clicked", false );</code>
<x-expl id="on_click"></x-expl><code>    d3.select( this ).classed( "clicked", true );</code>
<x-expl id="skip"></x-expl><code>    ...</code>
<x-expl id="on_click"></x-expl><code>  });</code>
<x-expl id="scatter"></x-expl><code>lc.lineChart( "line", scatterplot )</code>
<x-expl id="skip"></x-expl><code>	...</code>
<x-expl id="scatter"></x-expl><code>  .place( "#scatterplot" );</code>

<x-expl id="layer"></x-expl><code>var layer = scatterplot.get_layer( "layer0" );</code>

<x-expl id="colourSlider"></x-expl><code>var scatterSlider = lc.sigmoidColorSlider()</code>
<x-expl id="size"></x-expl><code>	.width( 300 )</code>
<x-expl id="size"></x-expl><code>	.height( 110 )</code>
<x-expl id="set_margin"></x-expl><code>	.set_margin( {top: 50} )</code>
<x-expl id="title"></x-expl><code>	.title( "Total curvefitting error" )</code>
<x-expl id="straightColorScale"></x-expl><code>	.straightColorScale( layer.colourScale )</code>
<x-expl id="on_change"></x-expl><code>	.on_change( function(){</code>
<x-expl id="on_change"></x-expl><code>		layer.updatePointStyle();</code>
<x-expl id="on_change"></x-expl><code>	} )</code>
<x-expl id="colourSlider"></x-expl><code>  .place( "#scatterplot" );</code>

<x-expl id="colour"></x-expl><code>layer.colour(function( id ){</code>
<x-expl id="colour"></x-expl><code>	return scatterSlider.colourScale( layer.get_colourValue( id ) );</code>
<x-expl id="colour"></x-expl><code>});</code>

<x-expl id="curveFit"></x-expl><code>var curveFit = lc.scatterChart( "points" )</code>
<x-expl id="skip"></x-expl><code>	...</code>
<x-expl id="curveFit"></x-expl><code>  .place( "#scatterplot" );</code>
</pre>
</td>
<td valign="top" style="padding-left:20px">

<style>
div.expl {
   display: none;
   position: absolute;
   background: #EBBCD8;
   width: 40%;
   padding: 10px;
}
</style>

<p style="background:#f0fff0; padding:10px"><i>Click on all the yellow bubbles (<img height="10pt" src="src/bubble_yellow.svg">),
going from top to bottom, to see explanations of the code.</i></p>
<br>

<div class="expl" id="heatmap">
<p>The heatmap is set almost exactly as it was done in previous examples, except for the two properties: <tt>margin</tt> 
and <tt>showLegend</tt>. So here, all other properties were omitted for the sake of simplisity</p>
</div>

<div class="expl" id="skip">
<p>Some lines of code, whose functionality had been already described in previous examples, were omitted 
for the sake of simplicity. <span style = "color: #44b; font-weight: bold;"
 onclick="window.open('colourSlider_code.html', 'newwindow', 'width=800, height=800');">
Here</span>, you can find the complete working code.</p>
</div>

<div class="expl" id="showLegend">
<p>Since we are going to use colour slider instead of the default legend, we would like to not to have both. The default 
legend can be turned off by setting <tt>showLegend</tt> property to <tt>false</tt>.</p>
</div>

<div class="expl" id="margin">
<p>Each chart has <tt>top, bottom, left</tt> and <tt>right</tt> margins, which are used to place axes, titles, legengds. 
Margins can be set, by an defining an object that has these four fields. Here, we wand to make the bottom margin smaller since 
we are not displaying legend any more. There is also a <tt>set_margin</tt> function to change only some of the fields and not care 
about others.</p>
</div>

<div class="expl" id="margin">
<p><tt>set_margin</tt> is another function to define margins. Unlike the default setter <tt>chart.margin()</tt>, it doesn't 
require all the fields to be defined, and thus allows to change only some of the margins without redefining others.</p>
</div>

<div class="expl" id="colourSlider">
<p>A <tt>sigmoidColourSlider</tt> is another type of basic types of charts implemented in the <tt>linked-charts</tt> library. 
It's not a selfsuficient chart, but it can be linked to any continuous colour scale of any of the plots, to allow an easy and 
interactive way of changing the contrast and the midpoint of the scale.</p>
</div>

<div class="expl" id="straightColorScale">
<p>Here, we define the colour scale that a colour slider will then modify. In both cases here, we used a colour scale that was 
internaly defined for the plots from user-set <tt>palette</tt> and colourRange <tt>properties</tt>. The other option is use here 
any other unrelated colour scale, since the colours for the plot will be in any case picked from a transformed by the 
<tt>sigmoidColorSlider</tt> scale.</p>
</div>

<div class="expl" id="on_change">
<p>By setting the <tt>on_change</tt> property user defines, what should be done if one of the pointers of a colour slider has been 
moved. Generally, we would like to have colours of all the cells or points (or other elements) changed. The most obvious way for that 
to use the <tt>chart.update()</tt> function. But in this case we know for sure that it's only the colour that has been changes. So we 
don't need all the chart elements to be recalculated and rerendered, since with larger charts this may take a considerable amount of 
time. To make this possible the update function for each chart in fact consists of several independent modules that can be called 
separately. Here, we use <tt>updateCellColour()</tt> function that is defined for heatmaps and <tt>updatePointStyle</tt> for plots with
axes.</p>
</div>

<div class="expl" id="colour">
<p>Here, we connect our plots with colour sliders by resetting the <tt>colour</tt> property. Setting colour directly always overrides 
any ohter settings for colours like <tt>palette</tt>, or <tt>colourRange</tt>, or <tt>colourScale</tt> (which not in fact a property, but
an internaly defined field). This makes <tt>colour</tt> property an ideal connection point between a plot and a corresponding colour 
slider. Note, that <tt>colour</tt> property of heatmaps gets value, while the same property of charts with axes get an ID of a data 
point (or any other element). The value can be directly passed to <tt>slider.colourScale</tt>, but ID first needed to be converted 
by <tt>layer.get_colourValue(<i>id</i>)</tt> function.</p>
</div>

<div class="expl" id="scatter">
<p>Initializing and placing a correlation scatter plot and a diogonal line.</p>
</div>

<div class="expl" id="on_click">
<p>Another nice thing to do, besides updating a curve fit plot, when a point on a correlation plot is clicked, is to mark this point.
Among default styles, used by the <tt>linked-charts</tt> library there is a class <tt>"clicked"</tt>. In these few lines, we first 
deselect all points on the plot, and then select the currently clicked one <tt>d3.select(this)</tt> by adding <tt>clicked</tt> 
to the list of its classes.</p>
</div>

<div class="expl" id="layer">
<p>Here, we save the layer of the correlation plot that contains all the points to a separate variable. The default of the ID of each 
layer is "layerN", where N is it's number starting from zero. <tt>chart.get_layer(id)</tt> returns a layer by its ID.</p>
</div>

<div class="expl" id="size">
<p>Here, we set size of the second colour slider.</p>
</div>

<div class="expl" id="title">
<p>Here, we define a title of the second slider.</p>
</div>

<div class="expl" id="curveFit">
<p>Here, we initialize and place the a plot to show the curvefits and inhibition values for all individual concentrations.</p>
</div>
</td></tr>
</table>

<script>
d3.selectAll( "x-expl" )
   .append( "img" )
      .attr( "height", "10pt" )
      .attr( "class", "bubble_icon" )
      .attr( "src", "src/bubble_yellow.svg" )
      .style( "padding-right", "15px")
      .on( "click", function() {
      	  d3.selectAll( "div.expl" )
      	     .style( "display", "none" );
          d3.selectAll( "img.bubble_icon" )
             .attr( "src", "src/bubble_yellow.svg")
      	  var tagId = d3.select(this.parentNode).attr("id");
      	  d3.select( "div.expl#" + tagId )
      	     .style( "display", "block" )
          d3.selectAll( "x-expl#" + tagId ).select("img.bubble_icon")
             .attr( "src", "src/bubble_red.svg")
       })
</script>

</body>

</html>