<html>

<head>

<title>Linked charts - Lines and Colour</title>
<script src="../src/linked-charts.min.js"></script>
<link rel="stylesheet" type="text/css" href="../src/linked-charts.css">
<link rel = "stylesheet" type = "text/css" href = "../src/default.css">
<link rel = "stylesheet" type = "text/css" href = "../src/strapdown.css">
<link rel = "stylesheet" type = "text/css" href = "../src/themes/bootstrap-responsive.min.css">
<link rel = "stylesheet" type = "text/css" href = "../src/themes/simplex.min.css">
<link rel="stylesheet" href="../src/prism.css">
<script src = "../src/prism.js"></script>

</head>

<body>
<script src="../src/navTop.js"></script>
<div class="container">
<h1>Lines and Colour</h1>

<p>Here, we show how to draw line plots. Let's add a diogonal line to the upper scatter plot and fitted curves
for both drugs to the bottom one. We also use colour to indicate the samples, where curvefitting wasn't succesfull.
Red dots on the correlation scatterplots show cell lines with bad fitting for at least one of two selected drugs.</p>

<script src = "../src/data/inputdata.js"></script>

<table><tr>
  <td id="heatmap" valign="top"></td>
  <td id="scatterplot" valign="top"></td>
</tr></table>

<script>

inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);
var drugs = Object.keys(inputData.RTG),
  cellLines = Object.keys(inputData.RTG[drugs[0]]);

var selDrugs = [drugs[0], drugs[1]],
  selCellLine = cellLines[0];

var heatmap = lc.heatmap()
  .rowIds( drugs )
  .colIds( drugs )
  .colourDomain( [ -1, 1 ] )
  .palette( d3.interpolateRdBu )
  .margins({top: 50, left: 50, right: 100, bottom: 100})  
  .value( function( rowId, colId ) {  
    var rowValues = cellLines.map(function(e) {
        return inputData.RTG[rowId][e].avInh;
      }),
      colValues = cellLines.map(function(e) {
        return inputData.RTG[colId][e].avInh;
      });
    return lc.pearsonCorr( rowValues, colValues ); 
   })
  .cluster( "Row" )
  .cluster( "Col" )
  .on_click( function( rowId, colId ) {
     selDrugs = [rowId, colId]
     scatterplot.update();
     curveFit.update();
  })
  .place( "#heatmap" );



var get_curve = function( drug, cellLine, x ){
  var max = inputData.RTG[drug][cellLine].max,
    min = inputData.RTG[drug][cellLine].min,
    IC50 = inputData.RTG[drug][cellLine].IC50,
    slope = inputData.RTG[drug][cellLine].Slope,
    minConc = inputData.RTG[drug][cellLine].minConc;
      
  return min + (max - min)/
    (1 + Math.pow(10, -(x - Math.log10(IC50/minConc)) * slope));
}

var scatterplot = lc.scatter()
  .width( 300 )
  .height( 300 )
  .dataIds( cellLines )
  .aspectRatio( 1 )
  .x( function( k ) { return inputData.RTG[selDrugs[0]][k].avInh } )
  .y( function( k ) { return inputData.RTG[selDrugs[1]][k].avInh } )
  .palette( ["green", "yellow","red"] )
  .colourValue( function ( k ) {
    var res = 0;
    for( var x = 0; x < 5; x++ )
      for( var l = 0; l < 2; l++ )
        res += Math.pow( get_curve( selDrugs[l], k, x ) - 
                    inputData.RTG[selDrugs[l]][k]["D" + (x + 1)], 2 ); 
    res = Math.sqrt( res );
    return res;
  })
  .colourDomain([0, 30]) 
  .on_click( function( k ) {
    selCellLine = k;
    curveFit.update();
  });
lc.xLine("line", scatterplot)
  .nelements(1)
  .lineFun( function( k, x ){
    return x;
  })
  .place( "#scatterplot" );

var curveFit = lc.scatter( "points" )
  .width( 300 )
  .height( 200 )
  .nelements( 10 )
  .x( function( k ) {
    return k % 5;
  } )
  .y( function( k ) {
    var ind = Math.floor( k / 5 );
    return inputData.RTG[selDrugs[ind]][selCellLine]["D" + (k % 5 + 1)];
  })
  .colour( function( k ) {
    return k > 4 ? "red" : "blue";
  } );
lc.xLine("lines", curveFit)
  .nelements(2)
  .lineFun( function( k, x ) {
    return get_curve( selDrugs[k], selCellLine, x );
  })
  .colour(function( k ){
    return k == 0 ? "blue" : "red";
  })
  .place( "#scatterplot" );
</script>

<div id = "navPanel"></div>
<script src = "../src/navigation.js"></script>
<script>
  showNavigationPanel(d3.select("#navPanel"), 0);
</script>

<br>
<br>
<br>
<h3>The code for the example</h3>

<p>A user of our framework can create apps with very little code. The following code is not complete, since some lines that were
explained in the previous example are omitted for the sake of simplicity. <span style = "color: #b44; font-weight: bold;"
onclick="window.open('linesAndColour_code.html', 'newwindow', 'width=800, height=800');">Here</span> one can find the complete code for this example.</p>

<table><tr><td valign="top">
<pre class = "language-javascript example">
<x-expl id="heatmap"></x-expl><code>var heatmap = lc.heatmap()</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="heatmap"></x-expl><code>  .place( "#heatmap" );</code>

<x-expl id="get_curve"></x-expl><code>var get_curve = function( drug, cellLine, x ){</code>
<x-expl id="get_curve"></x-expl><code>  var max = inputData.RTG[drug][cellLine].max,</code>
<x-expl id="get_curve"></x-expl><code>    min = inputData.RTG[drug][cellLine].min,</code>
<x-expl id="get_curve"></x-expl><code>    IC50 = inputData.RTG[drug][cellLine].IC50,</code>
<x-expl id="get_curve"></x-expl><code>    slope = inputData.RTG[drug][cellLine].Slope,</code>
<x-expl id="get_curve"></x-expl><code>    minConc = inputData.RTG[drug][cellLine].minConc;</code>
      
<x-expl id="get_curve"></x-expl><code>  return min + (max - min)/</code>
<x-expl id="get_curve"></x-expl><code>         (1 + Math.pow(10, -(x - Math.log10(IC50/minConc)) * slope));</code>
<x-expl id="get_curve"></x-expl><code>}</code>

<x-expl id="scatter"></x-expl><code>var scatterplot = lc.scatter()</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="aspectRatio"></x-expl><code>  .aspectRatio( 1 )</code>
<x-expl id="colourValue"></x-expl><code>  .colourValue( function ( k ) {</code>
<x-expl id="colourValue"></x-expl><code>    var res = 0;</code>
<x-expl id="colourValue"></x-expl><code>    for( var x = 0; x < 5; x++ )</code>
<x-expl id="colourValue"></x-expl><code>      for( var l = 0; l < 2; l++ )</code>
<x-expl id="colourValue"></x-expl><code>        res += Math.pow( get_curve( selDrugs[l], k, x ) - </code>
<x-expl id="colourValue"></x-expl><code>                    inputData.RTG[selDrugs[l]][k]["D" + (x + 1)], 2 );</code>
<x-expl id="colourValue"></x-expl><code>    res = Math.sqrt( res );</code>
<x-expl id="colourValue"></x-expl><code>    return res;</code>
<x-expl id="colourValue"></x-expl><code>  })</code>
<x-expl id="palette"></x-expl><code>  .palette( ["green", "yellow","red"] )</code>
<x-expl id="colourRange"></x-expl><code>  .colourDomain([0, 30]);</code>
<x-expl id="line"></x-expl><code>lc.xLine("line", scatterplot)</code>
<x-expl id="npoints"></x-expl><code>  .nelements(1)</code>
<x-expl id="lineFun"></x-expl><code>  .lineFun( function( k, x ){</code>
<x-expl id="lineFun"></x-expl><code>    return x;</code>
<x-expl id="lineFun"></x-expl><code>  })</code>
<x-expl id="place"></x-expl><code>  .place( "#scatterplot" );</code>

<x-expl id="scatter"></x-expl><code>var curveFit = lc.scatter( "points" )</code>
<x-expl id="skip"></x-expl><code>  ...</code>
<x-expl id="npoints"></x-expl><code>  .nelements( 10 )</code>
<x-expl id="xy"></x-expl><code>  .x( function( k ) {</code>
<x-expl id="xy"></x-expl><code>    return k % 5;</code>
<x-expl id="xy"></x-expl><code>  } )</code>
<x-expl id="xy"></x-expl><code>  .y( function( k ) {</code>
<x-expl id="xy"></x-expl><code>    var ind = Math.floor( k / 5 );</code>
<x-expl id="xy"></x-expl><code>    return inputData.RTG[selDrugs[ind]][selCellLine]["D" + (k % 5 + 1)];</code>
<x-expl id="xy"></x-expl><code>  })</code>
<x-expl id="colour"></x-expl><code>  .colour( function( k ) {</code>
<x-expl id="colour"></x-expl><code>    return k > 4 ? "red" : "blue";</code>
<x-expl id="colour"></x-expl><code>  } );</code>
<x-expl id="line"></x-expl><code>lc.xLine("lines", curveFit)</code>
<x-expl id="npoints"></x-expl><code>  .nelements(2)</code>
<x-expl id="lineFun"></x-expl><code>  .lineFun( function( k, x ) {</code>
<x-expl id="lineFun"></x-expl><code>    return get_curve( selDrugs[k], selCellLine, x );</code>
<x-expl id="lineFun"></x-expl><code>  })</code>
<x-expl id="colour"></x-expl><code>  .colour(function( k ){</code>
<x-expl id="colour"></x-expl><code>    return k == 0 ? "blue" : "red";</code>
<x-expl id="colour"></x-expl><code>  })</code>
<x-expl id="place"></x-expl><code>  .place( "#scatterplot" );</code>
</pre>
</td>
<td valign="top" style="padding-left:20px">

<style>
div.expl {
   display: none;
   position: absolute;
   background: #EBBCD8;
   width: 40%;
   padding: 10px;
}
</style>

<p style="background:#f0fff0; padding:10px"><i>Click on all the yellow bubbles (<img height="10pt" src="../src/img/bubble_yellow.svg">),
going from top to bottom, to see explanations of the code.</i></p>
<br>

<div class="expl" id="heatmap">
<p>The heatmap is set exactly as it was done in previous example. So here, all its properties were omitted
for the sake of simplisity</p>
</div>

<div class="expl" id="skip">
<p>Some lines of code, whose functionality had been already described in previous examples, were omitted 
for the sake of simplicity. <span style = "color: #44b; font-weight: bold;"
 onclick="window.open('linesAndColour_code.html', 'newwindow', 'width=800, height=800');">
Here</span>, you can find the complete working code.</p>
</div>

<div class="expl" id="get_curve">
<p>In this data set for each samples we have all the parameters of fitted sigmoid curves: the lower asymptote 
(<tt>min</tt>), the upper asymptote (<tt>max</tt>), the growth rate (<tt>slope</tt>) and the inflection point
(<tt>IC50</tt>). Using these parameters, <tt>get_curve</tt> function returns the value of fitted curve at 
point <tt>x</tt>. Note, that in these data all drugs were tested at five different concentrations, each 10 times
higher than the previous one. As x-Axis we are using values from 0 to 4, which correspond to log10 of each 
concentration divided by minimal tested concentration.</p>
</div>

<div class="expl" id="scatter">
<p>Here, both scatter plots are now parts of charts with layers. Note, that setting an ID for a layer is 
optional. For instance, the ID of scatter plot layer on the first plot will be automatically set to <tt>layer0</tt></p>
</div>

<div class="expl" id="aspectRatio">
<p>Here, we fix aspect ration for x and y axes to 1.</p>
</div>

<div class="expl" id="colourValue">
<p>Besides defining colours for each point directly (using <tt>colour</tt> property), one can set colours by providing a 
value for each data point, so that points with the same colour value will have the same colour. Numeric colour values will 
lead to a continuous colour scale, while using strings will define a categorical colour scale.</p>
<p>Here, for each point we calculate the squared root of sum of squared residuals for a selected cell line and both selected 
drug and use this value to define colours.</p>
</div>

<div class="expl" id="palette">
<p>The default set of colours for a continuous colour scale is <tt>d3.schemeSpectral</tt>, which goes from red to blue through 
yellow. You can use in this property any other d3 interpolator or any d3 scale that will transform some numeric range into a set of
colours. Another option is to use an array of colours as it is shown here. We want "bad" examples to be coloured red, "nice" to be green, 
suspicious - yellow.</p>
</div>

<div class="expl" id="colourRange">
<p>By default the domain of the colour scale is defined as the range that encompasses all the colour values of the data points. So 
even if for a certain pair of drugs there is no badly fitted samples, some of the dots still will be coloured red. To address this 
we can manually defined a range of colour values that will be fixed for all drugs. No all the points with colour values close to zero 
will be green, while all with values around 40 and higher - red.</p>
</div>

<div class="expl" id="line">
<p><tt>xLine</tt> is another basic type of plots that are implemented in the <tt>linked-charts</tt> library. It can display one 
or several lines, defined as <i>y = f(x)</i> functions. Scatter plots and lines can not be put on one layer, so if you want to have them 
both on one chart, you need create several layers. Here, the lines are added as second layers to existing charts.</p>
</div>

<div class="expl" id="npoints">
<p>Number of lines is set by the same property as number of points in scatter plots. And in the same manner, instead of setting the number of 
lines, one can define a set of all IDs via <tt>dataIds</tt> property.</p>
</div>

<div class="expl" id="lineFun">
<p>Each line in line charts should be defined as <i>y = f(x)</i> function. This is done by setting <tt>lineFun</tt>
property. This should be a function with two arguements: the first one is an ID of the line, the second is an x 
value. The function should return the corresponding y value.</p>
</div>

<div class="expl" id="place">
<p>The place functions insert the object just defined into the web page. The argument is a CSS selector,
here selecting the tabl elements that were marked with <tt>id</tt> attributes as the places to
take up the charts.</p>
<p>Each plot is placed into a separate <tt>div</tt> element, so one can place several charts into one 
element. Here, both scatterplots are placed into a single table cell.</p>
<p>Here, <tt>place</tt> is used after all the layers are defined. This is the recomended way to do it. Another option
is to use <tt>placeLayer(<i>layerID</i>)</tt> function for each layer added after </tt>place</tt> has been already 
called. Note, that calling <tt>place</tt> function twice will result in creating multiple instances.</p>
</div>

<div class="expl" id="xy">
<p>In previous example, points, corresponding to each drug, were added separately, using two layers. Here, we show,
how to do it in one layer. Now we have 10 points with IDs from 0 to 9. The first five (with IDs from 0 to 4) correspond 
to the first selected drug, while the second five - to the second selected drug.</p> 
</div>

<div class="expl" id="colour">
<p>In the previous example we used <tt>colour</tt> property to set one colour for all the points in the particular 
layer. Otherwise <tt>colour</tt> property can be defined by a function that takes an ID of a point (or a line) and 
returns colour (as name, RGB or HEX value). Note, that setting colours directly via <tt>colour</tt> option overrides 
<tt>colourValue</tt> property.</p>
</div>

</td></tr>
</table>

<script>
d3.selectAll( "x-expl" )
   .append( "img" )
      .attr( "height", "10pt" )
      .attr( "class", "bubble_icon" )
      .attr( "src", "../src/img/bubble_yellow.svg" )
      .style( "padding-right", "15px")
      .on( "click", function() {
      	  d3.selectAll( "div.expl" )
      	     .style( "display", "none" );
          d3.selectAll( "img.bubble_icon" )
             .attr( "src", "../src/img/bubble_yellow.svg")
      	  var tagId = d3.select(this.parentNode).attr("id");
      	  d3.select( "div.expl#" + tagId )
      	     .style( "display", "block" )
          d3.selectAll( "x-expl#" + tagId ).select("img.bubble_icon")
             .attr( "src", "../src/img/bubble_red.svg")
       })
</script>

</div>

</body>

</html>