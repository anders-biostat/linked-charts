<html>

<head>

<title>Linked charts - Adding Layers</title>
<script src="../src/linked-charts.min.js"></script>
<link rel="stylesheet" type="text/css" href="../src/linked-charts.css">
<link rel = "stylesheet" type = "text/css" href = "../src/default.css">
<link rel = "stylesheet" type = "text/css" href = "../src/strapdown.css">
<link rel = "stylesheet" type = "text/css" href = "../src/themes/bootstrap-responsive.min.css">
<link rel = "stylesheet" type = "text/css" href = "../src/themes/simplex.min.css">
<link rel="stylesheet" href="../src/prism.css">
<script src = "../src/prism.js"></script>

</head>

<body>
<script src="../src/navTop.js"></script>
<div class="container">
<h1>Adding Layers</h1>


<p>In this and futher examples we provide more insight in the possibilities of the linked-charts 
library and show how to use it.</p>
<p>Some types of charts (for example, chart with axes) support layer system, where each layer can have 
its own set of properties that are defined independently from other layers' properties. This is a simple 
example of creating a chart with two layers.</p>
<p>The data used here are generated in a drug-screening experiment. 50 drugs at 5 different concentrations 
were tested against 21 pancreatic cancer cell lines. The heatmap shows drug-drug correlation. Like in the 
previous example, a click on a cell of  the heatmap reveals the underlying statistics by demonstrating on 
a scatter plot (right upper corner) the values of avarage inhibition for all tested cell lines and the two
selected drugs. By clicking on a data point one can select a cell line, and thus change the third plot 
(right bottom corner) that demonstrate individual inhibition percent values for the two selected drugs and 
the selected cell line.</p>

<script src = "../src/data/inputdata.js"></script>

<table><tr>
  <td id="heatmap" valign="top"></td>
  <td id="scatterplot" valign="top"></td>
</tr></table>

<script>

inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);
var drugs = Object.keys(inputData.RTG),
  cellLines = Object.keys(inputData.RTG[drugs[0]]);

var selDrugs = [drugs[0], drugs[1]],
  selCellLine = cellLines[0];

var heatmap = lc.heatmap()
  .rowIds( drugs )
  .colIds( drugs )
  .colourDomain( [ -1, 1 ] )
  .palette( d3.interpolateRdBu )
  .margins({top: 50, left: 50, right: 100, bottom: 100})
  .value( function( rowId, colId ) {  
    var rowValues = cellLines.map(function(e) {
        return inputData.RTG[rowId][e].avInh;
      }),
      colValues = cellLines.map(function(e) {
        return inputData.RTG[colId][e].avInh;
      });
    return lc.pearsonCorr( rowValues, colValues ); 
   })
  .cluster("Row")
  .cluster("Col")
  .on_click( function( rowId, colId ) {
     selDrugs = [rowId, colId]
     scatterplot.update();
     curveFit.update();
  })
  .place( "#heatmap");

var scatterplot = lc.scatter()
  .width( 300 )
  .height( 300 )
  .dataIds( cellLines )
  .x( function( k ) { return inputData.RTG[selDrugs[0]][k].avInh } )
  .y( function( k ) { return inputData.RTG[selDrugs[1]][k].avInh } )
  .on_click( function( k ) {
    selCellLine = k;
    curveFit.update();
  })
  .place( "#scatterplot" );

var curveFit = lc.scatter("drug1")
  .width( 300 )
  .height( 200 )
  .nelements( 5 )
  .x( function( k ) {return k;} )
  .y( function( k ) {
    return inputData.RTG[selDrugs[0]][selCellLine]["D" + (k + 1)];
  })
  .colour( "blue" );
lc.scatter("drug2", curveFit)
  .nelements( 5 )
  .x( function( k ) {return k} )
  .y( function( k ) {
    return inputData.RTG[selDrugs[1]][selCellLine]["D" + (k + 1)];
  })
  .colour("red")
  .place( "#scatterplot" );

</script>

<div id = "navPanel"></div>
<script src = "../src/navigation.js"></script>
<script>
  showNavigationPanel(d3.select("#navPanel"), 0);
</script>

<br>
<br>
<br>
<h3>The code for the example</h3>

<p>A user of our framework can create apps with very little code. The following code is not complete, since some lines that were
explained in the previous example are omitted for the sake of simplicity. <span style = "color: #b44; font-weight: bold;"
onclick="window.open('layers_code.html', 'newwindow', 'width=800, height=800');">Here</span> one can find the complete code for this example.</p>

<table><tr><td valign="top">
<pre class="example">
<x-expl id="inputdata"></x-expl><code class = "language-html">&lt;script></code>
<x-expl id="inputdata"></x-expl><code class = "language-javascript">  inputData = [{"CellLine":"Pa16C","Drug":"Galunisertib","minConc":1, ...}, ... ];</code>
<x-expl id="inputdata"></x-expl><code class = "language-html">&lt;/script></code>

<x-expl id="mainscript"></x-expl><code class = "language-html">&lt;script></code>
<x-expl id="separateBy"></x-expl><code class = "language-javascript">  inputData = lc.separateBy(inputData, ["screen", "Drug", "CellLine"]);</code>
<x-expl id="list"></x-expl><code class = "language-javascript">  var drugs = Object.keys(inputData.RTG),</code>
<x-expl id="list"></x-expl><code class = "language-javascript">    cellLines = Object.keys(inputData.RTG[drugs[0]]);</code>

<x-expl id="vars"></x-expl><code class = "language-javascript">  var selDrugs = [drugs[0], drugs[1]],</code> 
<x-expl id="vars"></x-expl><code class = "language-javascript">    selCellLine = cellLines[0];</code>

<x-expl id="heatmap"></x-expl><code class = "language-javascript">  var heatmap = lc.heatmap()</code>
<x-expl id="ids"></x-expl><code class = "language-javascript">    .rowIds( drugs )</code>
<x-expl id="ids"></x-expl><code class = "language-javascript">    .colIds( drugs )</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">    .value( function( rowId, colId ) { </code> 
<x-expl id="hm_value"></x-expl><code class = "language-javascript">      var rowValues = cellLines.map(function(e) {</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">          return inputData.RTG[rowId][e].avInh;</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">        }),</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">        colValues = cellLines.map(function(e) {</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">          return inputData.RTG[colId][e].avInh;</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">        });</code>
<x-expl id="hm_value"></x-expl><code class = "language-javascript">      return lc.pearsonCorr( rowValues, colValues );</code> 
<x-expl id="hm_value"></x-expl><code class = "language-javascript">     })</code>
<x-expl id="cluster"></x-expl><code class = "language-javascript">    .cluster("Row")</code>
<x-expl id="cluster"></x-expl><code class = "language-javascript">    .cluster("Col");</code>
<x-expl id="skip"></x-expl><code>    ...</code>
<x-expl id="place"></x-expl><code class = "language-javascript">    .place( "#heatmap");</code>

<x-expl id="scatter1"></x-expl><code class = "language-javascript">  var scatterplot = lc.scatter()</code>
<x-expl id="ids"></x-expl><code class = "language-javascript">    .dataIds( cellLines )</code>
<x-expl id="skip"></x-expl><code>    ...</code>
<x-expl id="place"></x-expl><code class = "language-javascript">    .place( "#scatterplot" );</code>

<x-expl id="layer1"></x-expl><code class = "language-javascript">  var curveFit = lc.scatter("drug1")</code>
<x-expl id="skip"></x-expl><code>    ...</code>
<x-expl id="npoints"></x-expl><code class = "language-javascript">    .nelements( 5 )</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    .x( function( k ) {return k;} )</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    .y( function( k ) {</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">      return inputData.RTG[selDrugs[0]][selCellLine]["D" + (k + 1)];</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    })</code>
<x-expl id="colour"></x-expl><code class = "language-javascript">    .colour( "blue" );</code>
<x-expl id="layer2"></x-expl><code class = "language-javascript">  lc.scatter("drug2", curveFit)</code>
<x-expl id="npoints"></x-expl><code class = "language-javascript">    .nelements( 5 )</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    .x( function( k ) {return k} )</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    .y( function( k ) {</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">      return inputData.RTG[selDrugs[1]][selCellLine]["D" + (k + 1)];</code>
<x-expl id="xy"></x-expl><code class = "language-javascript">    })</code>
<x-expl id="colour"></x-expl><code class = "language-javascript">    .colour("red")</code>
<x-expl id="place"></x-expl><code class = "language-javascript">    .place( "#scatterplot" );</code>
<x-expl id="mainscript"></x-expl><code class = "language-html">&lt;/script></code>
</pre>
</td>
<td valign="top" style="padding-left:20px">

<style>
div.expl {
   display: none;
   position: absolute;
   background: #EBBCD8;
   width: 40%;
   padding: 10px;
}
</style>

<p style="background:#f0fff0; padding:10px"><i>Click on all the yellow bubbles (<img height="10pt" src="../src/img/bubble_yellow.svg">),
going from top to bottom, to see explanations of the code.</i></p>
<br>

<div class="expl" id="loadlib">
<p>Here we load the <i>linked-charts</i> library and its stylesheet. It comes bundled with D3 and clusterfck.js.</p></div>

<div class="expl" id="inputdata">
<p>There are various ways to load the data. Here, we demonstrate the simplest way:
Just inline it into the page.</p>
<p>The data was originally an R matrix. We used the toJSON function of R's 'jsonlite' 
package to write out the data in a form that can be read in JavaScript, and copied and pasted
this here.</p>
<p>Of course, reading a CSV file is not much more difficult.</p>
</div>

<div class="expl" id="labelvectors">
The labels for the heat map will be taken from these two string vectors. The vectors
have lengths 35 and 10, but some of the elements have been omitted to not clutter the page. 
</div>

<div class="expl" id="matrices">
The main data are given in these two data matrices. The first contains
35 &times; 52 gene expression values for 35 genes (matrix rows) times
52 samples (matrix columns). The second contains drug response scores for 10 drugs
times the same 52 samples.</div>

<div class="expl" id="table">
The layout of a set of linked charts is specified by writing a normal web page
in standard HTML. Here, our page merely contains one table with one row and
two table data (&lt;td>) elements, each of which will take up one of the charts.
Further below, we will refer to these &lt;td> by the <tt>id</tt> attributes
that are set here.</div>

<div class="expl" id="mainscript">
This is the actual user script to use the <i>linked-charts</i> library. 
</div>


<div class="expl" id="vars">
<p>These two global variables provide the link between the heat map and the scatter plot:</p>
<p>They always show the row number (gene) and column number (drug) of the last heat map cell
on which the user has clicked (or, initially, 1, i.e., the top-left cell). 
</div>

<div class="expl" id="scatter1">
<p>Here, we initialize a "scatter" object. This is one of the standard chart types provided
by our "linked-charts" library.</p>
<p>In the following lines, we set the objects properties</p>
</div>

<div class="expl" id="xy">
<p>Linked-charts uses call-back functions to access the data: These two functions are called for
each data point, being passed the number of the data point as argument. They look up the gene 
expression and drug response score in the input matrices, looking at the column for sample <tt>k</tt>.<p> 
<p>The global variables defined above are consulted, so that the scatter plot uses the data from the rows
corresponding to gene and drug selected by the user's last click on the heatmap.</p>
<p>Axes and scaling is automatically adjusted to the value range (but this can be overridden).</p>
<p>Besides x and y coordinates, other properties of the data points such as colour, size etc, can 
be set similarly, either globally for all points by providing constants, or for each point separately, 
by providing call-back for properties like <tt>size</tt>, <tt>colour</tt>, etc. 
</div>

<div class="expl" id="place">
<p>The place functions insert the object just defined into the web page. The argument is a CSS selector,
here selecting the tabl elements that were marked with <tt>id</tt> attributes as the places to
take up the charts.</div>

<div class="expl" id="heatmap1">
<p>Here, we instantiate the second chart, namely the heatmap on the left. The heat map is another
of the standard chart types provided by linked charts.</div>

<div class="expl" id="hm_prop">
<p>Here, we set the basic properties of the heat map: The numbers of rows and columns,
and the height and width (in pixels).</p>
<p>The number of rows (number of genes) and columns (number of drugs) is read off from the number 
of rows of the two data arrays.</div>

<div class="expl" id="hm_col">
<p>We use <a href="https://github.com/d3/d3-scale-chromatic#interpolateRdBu">one of D3's color palettes</a> 
for the heatmap's colour scale. These colours should map
the correlation values, which range from -1 to 1.</p></div>

<div class="expl" id="hm_value">
<p>As do all charts in the linked-charts library, heat maps access their data via callback functions. For
this, the property <tt>value</tt> has to be set to a function that takes two arguments, <tt>row</tt> and
<tt>col</tt> and returns the value that the cell with the given position should show. 
Here, we provide a function that looks up the data row corresponding to <tt>row</tt> in 
the <tt>geneExpr</tt> matrix and the data row corresponding to <tt>col</tt> in 
the <tt>drugScore</tt> matrix. It then calculates for these two row vectors Pearson's correlation coefficient
and returns it.</p>
<p>This example shows that it is not necessary to bring the data into a specific form to display it with
<i>linked-charts</i>. Thanks to the call-back mechanism, we can code access to the data in whatever form it is provided
and even do small calculations on the fly.
</p></div>

<div class="expl" id="rowcolnames">
<p>The row and column labels displayed at the side of the heatmap are also provided by call-back functions,
which are called individually for each row and each column.</p>
<p>In our input data, the mapping of rows of the input data matrices to gene and drug names is provided
by two vectors of labels, which are accessed here.</p>
</div>

<div class="expl" id="click">
<p>The property <tt>on_click</tt> is set here to a call back function that is called whenever the user
clicks on a cell.</p>
<p>The function takes the row and column index of the clicked heat map cell from the provided arguments
and saves them in the two global variables <tt>selGene</tt> and <tt>selDrug</tt> that we have defined at the top and which are read by
the scatter plot's <tt>x</tt> and <tt>y</tt> call-backs. </p>
<p>Then, the <tt>update</tt> function of the scatter chart is called. This has to be done whenever the
data or appearance of a plot changed and the plot has to be re-rendered.</p>
<p>This simple and transparent style of linking two plots is the heart of <i>linked-charts</i>.</p>
</div>


</td></tr>
</table>

<script>
d3.selectAll( "x-expl" )
   .append( "img" )
      .attr( "height", "10pt" )
      .attr( "class", "bubble_icon" )
      .attr( "src", "../src/img/bubble_yellow.svg" )
      .style( "padding-right", "15px")
      .on( "click", function() {
      	  d3.selectAll( "div.expl" )
      	     .style( "display", "none" );
          d3.selectAll( "img.bubble_icon" )
             .attr( "src", "../src/img/bubble_yellow.svg")
      	  var tagId = d3.select(this.parentNode).attr("id");
      	  d3.select( "div.expl#" + tagId )
      	     .style( "display", "block" )
          d3.selectAll( "x-expl#" + tagId ).select("img.bubble_icon")
             .attr( "src", "../src/img/bubble_red.svg")
       })
</script>

</div>

</body>

</html>