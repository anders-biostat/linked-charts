//https://bl.ocks.org/Kcnarf/5c989173d0e0c74ab4b62161b33bb0a8 (original library was slightly modified)
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.d3=global.d3||{})})(this,function(exports){"use strict";function SortedDirectAccessDoublyLinkedList(){this._valueAccessor=function(obj){return obj.value};this._idAccessor=function(obj){return obj.id};this._min=null;this._max=null;this._closestTo0=null;this.size=0;this._idToNode={}}SortedDirectAccessDoublyLinkedList.prototype.valueAccessor=function(_){if(!arguments.length){return this._valueAccessor}this._valueAccessor=_;return this};SortedDirectAccessDoublyLinkedList.prototype.idAccessor=function(_){if(!arguments.length){return this._idAccessor}this._idAccessor=_;return this};SortedDirectAccessDoublyLinkedList.prototype.min=function(){return this._min};SortedDirectAccessDoublyLinkedList.prototype.max=function(){return this._max};SortedDirectAccessDoublyLinkedList.prototype.closestTo0=function(){return this._closestTo0};SortedDirectAccessDoublyLinkedList.prototype.dln=function(datum){return this._idToNode[this._idAccessor(datum)]};SortedDirectAccessDoublyLinkedList.prototype.empty=function(){this._min=null;this._max=null;this._closestTo0=null;this.size=0;this._idToNode={};return this};SortedDirectAccessDoublyLinkedList.prototype.add=function(datum){var dln={datum:datum,value:this._valueAccessor(datum),prev:null,next:null};if(this.size===0){this._min=this._max=this._closestTo0=dln}else{if(dln.value<=this._min.value){dln.next=this._min;dln.next.prev=dln;this._min=dln}else if(dln.value>=this._max.value){dln.prev=this._max;dln.prev.next=dln;this._max=dln}else{var current=this._max;while(current.value>dln.value){current=current.prev}dln.prev=current;dln.next=current.next;dln.next.prev=dln;dln.prev.next=dln}if(Math.abs(dln.value)<Math.abs(this._closestTo0.value)){this._closestTo0=dln}}this._idToNode[this._idAccessor(datum)]=dln;this.size++;return this};SortedDirectAccessDoublyLinkedList.prototype.addMany=function(data){data.forEach(function(datum,item){this.add(datum)},this);return this};SortedDirectAccessDoublyLinkedList.prototype.remove=function(datum){var dln=this.dln(datum);if(this.size===1){this._min=this._max=this._closestTo0=null}else{if(dln===this._closestTo0){if(this._closestTo0.next===null){this._closestTo0=dln.prev}else if(this._closestTo0.prev===null){this._closestTo0=dln.prev}else{var prevAbsValue=Math.abs(this._closestTo0.prev.value);var nextAbsValue=Math.abs(this._closestTo0.next.value);if(prevAbsValue<nextAbsValue){this._closestTo0=this._closestTo0.prev}else{this._closestTo0=this._closestTo0.next}}}if(dln===this._min){this._min=this._min.next;this._min.prev=null}else if(dln===this._max){this._max=this._max.prev;this._max.next=null}else{dln.next.prev=dln.prev;dln.prev.next=dln.next}}delete this._idToNode[this._idAccessor(datum)];dln=null;this.size--;return this};function beeswarm(){var data=[];var radius=4;var orientation="horizontal";var side="symetric";var distributeOn=function(datum){return datum.x};var axis=function(datum){return datum.y};var minDistanceBetweenCircles;var minSquareDistanceBetweenCircles;var xBasedDataManager;var xBasedColliderManager;var yBasedColliderManager;var arrangement;var totalPossibleColliders,maxPossibleColliders,totalTestedPlacements,visitedColliderCount,totalVisitedColliders,maxVisitedColliders;function _beeswarm(){}_beeswarm.data=function(_){if(!arguments.length){return data}data=_;return _beeswarm};_beeswarm.radius=function(_){if(!arguments.length){return radius}radius=_;return _beeswarm};_beeswarm.orientation=function(_){if(!arguments.length){return orientation}if(_==="horizontal"||_==="vertical"){orientation=_}return _beeswarm};_beeswarm.side=function(_){if(!arguments.length){return side}if(_==="symetric"||_==="positive"||_==="negative"){side=_}return _beeswarm};_beeswarm.distributeOn=function(_){if(!arguments.length){return distributeOn}distributeOn=_;return _beeswarm};_beeswarm.axis=function(_){if(!arguments.length){return distributeOn}axis=_;return _beeswarm};_beeswarm.arrange=function(){initArrangement();arrangement.forEach(function(d){var bestYPosition=-Infinity,relativeYPos,xBasedPossibleColliders=gatherXBasedPossibleColliders(d);if(xBasedPossibleColliders.length===0){bestYPosition=d.axis}else{yBasedColliderManager.empty();yBasedColliderManager.addMany(xBasedPossibleColliders);d.free=d.axis;if(!collidesWithOther(d,yBasedColliderManager.closestTo0())){bestYPosition=d.axis;totalVisitedColliders+=visitedColliderCount;if(visitedColliderCount>maxVisitedColliders){maxVisitedColliders=visitedColliderCount}visitedColliderCount=0;totalTestedPlacements+=1}else{xBasedPossibleColliders.forEach(function(xbpc){relativeYPos=yPosRelativeToXbpc(xbpc,d);placeBelow(d,xbpc,relativeYPos);if(isAuthorizedPlacement(d)&&isBetterPlacement(d,bestYPosition)&&!collidesWithOther(d,yBasedColliderManager.dln(xbpc))){bestYPosition=d.free}totalVisitedColliders+=visitedColliderCount;if(visitedColliderCount>maxVisitedColliders){maxVisitedColliders=visitedColliderCount}visitedColliderCount=0;totalTestedPlacements+=1;placeAbove(d,xbpc,relativeYPos);if(isAuthorizedPlacement(d)&&isBetterPlacement(d,bestYPosition)&&!collidesWithOther(d,yBasedColliderManager.dln(xbpc))){bestYPosition=d.free}totalVisitedColliders+=visitedColliderCount;if(visitedColliderCount>maxVisitedColliders){maxVisitedColliders=visitedColliderCount}visitedColliderCount=0;totalTestedPlacements+=1})}}d.free=bestYPosition;if(orientation==="horizontal"){d.x=d.fixed;d.y=bestYPosition}else{d.x=bestYPosition;d.y=d.fixed}xBasedColliderManager.add(d)});return arrangement};_beeswarm.metrics=function(){return{totalPossibleColliders:totalPossibleColliders,maxPossibleColliders:maxPossibleColliders,totalTestedPlacements:totalTestedPlacements,visitedColliderCount:visitedColliderCount,totalVisitedColliders:totalVisitedColliders,maxVisitedColliders:maxVisitedColliders}};function initArrangement(){arrangement=data.map(function(d,i){return{datum:d,id:i,fixed:distributeOn(d),axis:axis(d),free:-Infinity}});minDistanceBetweenCircles=2*radius;minSquareDistanceBetweenCircles=Math.pow(minDistanceBetweenCircles,2);xBasedDataManager=(new SortedDirectAccessDoublyLinkedList).valueAccessor(function(d){return d.fixed}).addMany(arrangement);xBasedColliderManager=(new SortedDirectAccessDoublyLinkedList).valueAccessor(function(d){return d.fixed});yBasedColliderManager=(new SortedDirectAccessDoublyLinkedList).valueAccessor(function(d){return d.free});totalPossibleColliders=maxPossibleColliders=0;totalTestedPlacements=0;visitedColliderCount=totalVisitedColliders=maxVisitedColliders=0}function findNearestPossibleCollider(dln,visitedDln,direction){if(visitedDln===null){return null}else if(direction==="prev"?dln.value-visitedDln.value>minDistanceBetweenCircles:visitedDln.value-dln.value>minDistanceBetweenCircles){return null}else{if(isFinite(visitedDln.datum.free)){return visitedDln.datum}return findNearestPossibleCollider(dln,visitedDln[direction],direction)}}function visitToGatherXBasedPossibleColliders(dln,visitedDln,direction,xBasedPossibleColliders){if(visitedDln===null){return}else if(direction==="prev"?dln.value-visitedDln.value>minDistanceBetweenCircles:visitedDln.value-dln.value>minDistanceBetweenCircles){return}else{xBasedPossibleColliders.push(visitedDln.datum);visitToGatherXBasedPossibleColliders(dln,visitedDln[direction],direction,xBasedPossibleColliders)}}function gatherXBasedPossibleColliders(datum){var xBasedPossibleColliders=[];var dln=xBasedDataManager.dln(datum);var nearestXPrevAlreadyArrangedData=findNearestPossibleCollider(dln,dln.prev,"prev");var nearestXNextAlreadyArrangedData=findNearestPossibleCollider(dln,dln.next,"next");if(nearestXPrevAlreadyArrangedData!=null){dln=xBasedColliderManager.dln(nearestXPrevAlreadyArrangedData);visitToGatherXBasedPossibleColliders(dln,dln,"prev",xBasedPossibleColliders)}if(nearestXNextAlreadyArrangedData!=null){dln=xBasedColliderManager.dln(nearestXNextAlreadyArrangedData);visitToGatherXBasedPossibleColliders(dln,dln,"next",xBasedPossibleColliders)}totalPossibleColliders+=xBasedPossibleColliders.length;if(xBasedPossibleColliders.length>maxPossibleColliders){maxPossibleColliders=xBasedPossibleColliders.length}return xBasedPossibleColliders}function isAuthorizedPlacement(datum){if(side==="symetric"){return true}else if(side==="positive"){return datum.free>=0}else{return datum.free<=0}}function isBetterPlacement(datum,bestYPosition){return Math.abs(datum.free-datum.axis)<Math.abs(bestYPosition-datum.axis)}function yPosRelativeToXbpc(xbpc,d){return Math.sqrt(minSquareDistanceBetweenCircles-Math.pow(d.fixed-xbpc.fixed,2))+1e-6}function placeBelow(d,aad,relativeYPos){d.free=aad.free-relativeYPos}function placeAbove(d,aad,relativeYPos){d.free=aad.free+relativeYPos}function areCirclesColliding(d0,d1){visitedColliderCount++;return Math.pow(d1.free-d0.free,2)+Math.pow(d1.fixed-d0.fixed,2)<minSquareDistanceBetweenCircles}function visitToDetectCollisionWithOther(datum,visitedDln,direction,visitCount){if(visitedDln===null){return false}else if(direction==="prev"?datum.free-visitedDln.datum.free>minDistanceBetweenCircles:visitedDln.datum.free-datum.free>minDistanceBetweenCircles){return false}else if(areCirclesColliding(datum,visitedDln.datum)){return true}else{return visitToDetectCollisionWithOther(datum,visitedDln[direction],direction,visitCount++)}}function collidesWithOther(datum,visitedDln){var visitCount=0;if(visitToDetectCollisionWithOther(datum,visitedDln,"prev",visitCount++)){return true}else{return visitToDetectCollisionWithOther(datum,visitedDln,"next",visitCount++)}}return _beeswarm}exports.beeswarm=beeswarm;Object.defineProperty(exports,"__esModule",{value:true})});