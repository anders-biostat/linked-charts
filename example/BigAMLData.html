<html>

<title>Linked charts with D3</title>
<link rel="stylesheet" type="text/css" href="../src/style.css">
<script src = "https://d3js.org/d3.v4.min.js"></script>
<script src = "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src = "https://d3js.org/d3-color.v1.min.js"></script>
<script src = "input_BigAMLData.js"></script>
<script src = "../src/lib/clusterfck.js"></script>
<script src="https://cdn.rawgit.com/Gmousse/dataframe-js/master/lib/browser/dataframe-min.js"></script>
<script src = "http://cdn.jsdelivr.net/jstat/latest/jstat.min.js"></script>
<script src = "../build/d3-linked-charts.js"></script>

<body>
<table>
	<tr>
		<td>
			<div id = "heatmap"></div>
			<div id = "slider"></div>
			<table>
				<tr>
					<td>
						Sort rows: 
						<select id = "sortRows" onchange = "reorderRow();">
							<option value = "cluster">Cluster</option>
							<option value = "drug">By drug</option>
							<option value = "sample">By sample</option>
						</select><br>
						Sort cols:
						<select id = "sortCols" onchange = "reorderCol();">
							<option value = "cluster">Cluster</option>
							<option value = "drug">By drug</option>
							<option value = "sample">By sample</option>
						</select>
					</td>
					<td>
						<input type = "radio" value = "CTG" name = "screen" onchange = "switchHeatmap();" checked>CTG<br>
						<input type = "radio" value = "CTxG"  name = "screen" onchange = "switchHeatmap();">CTxG
					</td>
					<td>
						<button onclick = "recalculateCors();">Recalculate correlations</button>
					</td>
				</tr>
			</table>
			<table>
				<tr>
					<td>
						Show samples:<br>
						<div id = "samples"></div>
					</td>
					<td>
						Show drugs: <br>
						<div id = "drugs"></div>
					</td>
				</tr>
			</table>			
		</td>
		<td>

			<div id = "scatter"></div>
			<h4 id = "curveFitTitle" align = "center"></h4>
			<div id = "curveFit"></div>
			<svg id = "curveFitLegend"></svg>

		</td>
	</tr>
</table>


<script>

//var DataFrame = dfjs.DataFrame;

//add avarage inhibition values
for(var i = 0; i < inputData.length; i++){
	inputData[i].avInh = jStat.mean([inputData[i].D1, inputData[i].D2,
		inputData[i].D3, inputData[i].D4, inputData[i].D5]);
}
//var df = new DataFrame(inputData);
//Get a set of drugnames
var drugs = [];
for(var i = 0; i < inputData.length; i++){
	if(drugs.indexOf(inputData[i].DRUG_NAME) == -1)
		drugs.push(inputData[i].DRUG_NAME);
}
//Get a set of samplenames
var samples = [];
for(var i = 0; i < inputData.length; i++){
	if(samples.indexOf(inputData[i].sample) == -1)
		samples.push(inputData[i].sample);
}
//Get a set of main drugs
var mainDrugs = [];
for(var i = 0; i < inputData.length; i++){
	if(mainDrugs.indexOf(inputData[i].mainDrug) == -1)
		mainDrugs.push(inputData[i].mainDrug);
}
samples = samples.sort();
drugs = drugs.sort();
mainDrugs = mainDrugs.sort();
var markedDrugs = drugs.slice();
var screen = "CTG";

inputData = d3.separateBy(inputData, ["screen", "sample", "mainDrug", "DRUG_NAME"]);

//add drug checkboxes
var chB = d3.select("#drugs").selectAll("input")
	.data(mainDrugs).enter().append("div");
chB.append("input")
	.attr("type", "checkbox")
	.attr("id", function(d) {return d;})
	.attr("checked", true)
	.attr("onchange", "switchHeatmap();");
chB.append("label")
	.attr("for", function(d) {return d;})
	.text(function(d) {return d;});
//add sample checkboxes
var chB = d3.select("#samples").selectAll("input")
	.data(samples).enter().append("div");
chB.append("input")
	.attr("type", "checkbox")
	.attr("id", function(d) {return d;})
	.attr("checked", true)
	.attr("onchange", "switchHeatmap();");
chB.append("label")
	.attr("for", function(d) {return d;})
	.text(function(d) {return d;});		

reorderRow = function(){
	var sort = document.getElementById("sortRows").value;
	if(sort == "cluster")
		layer.clusterRows();
	var ids = get_inds();
	if(sort == "sample"){
		heatmap.reorderRow(function(a, b){return a > b;})
	}
	if(sort == "drug"){
		var invIds = [];
		for(var i = 0; i < ids.length; i++)
			invIds.push(ids[i].split("/")[1] + "/" + ids[i].split("/")[0]);
		invIds.sort();
		heatmap.reorderRow(function(a, b){return invIds.indexOf(a) > invIds.indexOf(b);})
	}
}
reorderCol = function(){
	var sort = document.getElementById("sortCols").value;
	if(sort == "cluster")
		layer.clusterCols();
	var ids = get_inds();
	if(sort == "sample"){
		heatmap.reorderCol(function(a, b){return a > b;})
	}
	if(sort == "drug"){
		var invIds = [];
		for(var i = 0; i < ids.length; i++)
			invIds.push(ids[i].split("/")[1] + "/" + ids[i].split("/")[0]);
		invIds.sort();
		heatmap.reorderCol(function(a, b){return invIds.indexOf(a) > invIds.indexOf(b);})
	}
}
	
get_inds = function(){
	var selSamples = d3.select("#samples").selectAll("input")
		.filter(function() {return this.checked;})
		.data();
	
	var selDrugs = d3.select("#drugs").selectAll("input")
		.filter(function() {return this.checked;})
		.data();

	var selIds = [];
	for(var i = 0; i < selSamples.length; i++)
		for(var j = 0; j < selDrugs.length; j++)
			if(inputData[screen][selSamples[i]][selDrugs[j]])
				selIds.push(selSamples[i] + "/" + selDrugs[j]); 

	return selIds;
}

find_cors = function(rowId, colId){
	var rowSample = rowId.split("/")[0],
		rowDrug = rowId.split("/")[1],
		colSample = colId.split("/")[0],
		colDrug = colId.split("/")[1],
		colVect = [], rowVect =[];

	for(var i = 0; i < markedDrugs.length; i++){
	var col = inputData[screen][colSample][colDrug][markedDrugs[i]],
			row = inputData[screen][rowSample][rowDrug][markedDrugs[i]];
		if(col && row){
			colVect.push(col.avInh);
			rowVect.push(row.avInh);
		}
	}
	return jStat.corrcoeff(rowVect, colVect);
}

//Let's create correlation matrix by hand - this will improve the performance
var corMatr = {}, inds = get_inds(), k_key;
for(var k = 0; k < Object.keys(inputData).length; k++){
	k_key = Object.keys(inputData)[k];
	corMatr[k_key] = {};
	screen = k_key;
	for(var i = 0; i < inds.length; i++){
		corMatr[k_key][inds[i]] = {};
		for(var j = 0; j < inds.length; j++){
			console.log(inds[i] + " " + inds[j])
			corMatr[k_key][inds[i]][inds[j]] = find_cors(inds[i], inds[j]);
		}
	}
}
screen = "CTG";
//alternative way to get values (using precalculated correlation matrix)
get_value = function(rowId, colId){
	return corMatr[screen][rowId][colId];	
}

recalculateCors = function(){
	markedDrugs = scatter.container.selectAll(".marked").data();
	if(markedDrugs.length < 2){
		markedDrugs = drugs.slice();
	}
	for(var k = 0; k < Object.keys(inputData).length; k++){
		k_key = Object.keys(inputData)[k];
		corMatr[k_key] = {};
		screen = k_key;
		for(var i = 0; i < inds.length; i++){
			corMatr[k_key][inds[i]] = {};
			for(var j = 0; j < inds.length; j++){
				console.log(inds[i] + " " + inds[j])
				corMatr[k_key][inds[i]][inds[j]] = find_cors(inds[i], inds[j]);
			}
		}
	}
	heatmap.update();
	var sortRows = document.getElementById("sortRows").value,
		sortCols = document.getElementById("sortCols").value;

	if(sortRows == "cluster")
		layer.clusterRows();
	if(sortCols == "cluster")
		layer.clusterCols();
}
function get_residuals(id, sample, mainDrug){
	res = 0;
	minConc = inputData[screen][sample][mainDrug][id]["Min.Conc.tested"];
	for(var k = 1; k <= 5; k++){
		res += Math.pow(curveFunction(sample, mainDrug, id, Math.log10(minConc * Math.pow(10, k - 1))) - 
							inputData[screen][sample][mainDrug][id]["D" + k], 2);
	}
	res = Math.sqrt(res);
	return res;
}

function curveFunction (sample, mainDrug, drug, x) {
	var max = inputData[screen][sample][mainDrug][drug].MAX,
		min = inputData[screen][sample][mainDrug][drug].MIN,
		IC50 = inputData[screen][sample][mainDrug][drug].IC50,
		slope = inputData[screen][sample][mainDrug][drug].SLOPE;
		
		return min + (max - min)/(1 + Math.pow(10, -(x - Math.log10(IC50)) * slope))
}

var colorScale = d3.scaleLinear()
	.range([0, 1])
	.domain([0, 25]);	

switchHeatmap = function(){
	var radios = document.getElementsByName('screen');
	radios[0].checked ? screen = "CTG" : screen = "CTxG";
	heatmap.update();
	var sortRows = document.getElementById("sortRows").value,
		sortCols = document.getElementById("sortCols").value;
	if(sortRows == "cluster")
		layer.clusterRows();
	if(sortCols == "cluster")
		layer.clusterCols();
	scatter.update();
	curveFit.update();
}
setNames = function(){
	d3.select("#curveFitTitle")
		.text(selectedDrug);
	d3.select("#curveFitLegend")
		.select("#row")
		.text(selRowId);
	d3.select("#curveFitLegend")
		.select("#col")
		.text(selColId);

}

	
var heatmap = d3.heatmapChart()
	.rowIds(get_inds)
	.colIds(get_inds)
	.value(get_value)
	.colourRange([-1, 1])
	.margin({top: 150, bottom: 10, left: 150, right: 10})
	.palette(function(t) {return d3.interpolateRdYlBu(1 - t);})
	.on_click(function(rowId, colId){
		selColId = colId;
		selRowId = rowId;
		scatter.update();
		curveFit.update();
		setNames();
	})
	.place("#heatmap");

var layer = heatmap.get_layer("layer0");
layer.clusterCols();
layer.clusterRows();
var slider = d3.sigmoidColorSlider()
	.straightColorScale(layer.colourScale)
	.margin({top: 30, bottom: 10, left: 10, right: 10})
	.on_change(function(){
		layer.colour(function(val){
			return layer.get_palette(slider.the_sigmoid(val));
		});
		layer.updateColour();
	})
  .place("#slider");

var selRowId = get_inds()[0],
	selColId = get_inds()[1];

var scatter = d3.scatterChart()
	.x(function(id) {
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1];
		return inputData[screen][rowSample][rowDrug][id].avInh;
	})
	.y(function(id){
		var colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1];
		return inputData[screen][colSample][colDrug][id].avInh;
	})
	.dataIds(function(){
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1],
			colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1],
			row = Object.keys(inputData[screen][rowSample][rowDrug]),
			col = Object.keys(inputData[screen][colSample][colDrug]),
			drugs = [];
		for(var i = 0; i < row.length; i++)
			if(col.indexOf(row[i]) != -1)
				drugs.push(row[i]);
		return drugs;
	})
	.labelX(function() {return selRowId})
	.labelY(function() {return selColId})
	.colour(function(id){
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1],
			colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1];
		var res = (get_residuals(id, rowSample, rowDrug) + get_residuals(id, colSample, colDrug))/2;
		return "rgb(" + Math.round(Math.pow(colorScale(res), 3) * 255) + ", " +  
							Math.round(80 + Math.pow((1 - colorScale(res)), 3) * 150) + "," + 
							Math.round(Math.pow(1 - colorScale(res), 3) * 150) + ")";

	})
	.size(5)
	.width(400)
	.height(400)
	.on_click(function(id){
		selectedDrug = id;
		curveFit.update();
		setNames();
	})
	.place("#scatter");

var selectedDrug = Object.keys(inputData[screen][selRowId.split("/")[0]][selRowId.split("/")[1]])[0]
var curveFit = d3.axisChartBase()
	.height(250)
	.labelX("Concentration (log10)")
	.labelY("Inhibition")
	.domainY([-20, 100]);
d3.scatterChart("scatter", curveFit)	
	.npoints(10)
	.x(function(i){
		var x;
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1],
			colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1];

		if(Math.abs(2 - i) <= 2){
			x = inputData[screen][rowSample][rowDrug][selectedDrug]["Min.Conc.tested"] * Math.pow(10, i);
		}
		if(Math.abs(7 - i) <= 2){
			x = inputData[screen][colSample][colDrug][selectedDrug]["Min.Conc.tested"] * Math.pow(10, i - 5);
		}
		return Math.log10(x);
	})
	.y(function(i){
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1],
			colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1];
		
		if(Math.abs(2 - i) <= 2){
			return inputData[screen][rowSample][rowDrug][selectedDrug]["D" + (i + 1)];
		}
		if(Math.abs(7 - i) <= 2){
			return inputData[screen][colSample][colDrug][selectedDrug]["D" + (i - 4)];
		}
	})
	.colour(function(i){
		if(Math.abs(2 - i) <= 2){
			return "red";
		}
		if(Math.abs(7 - i) <= 2){
			return "blue";
		}
	});
d3.lineChart("line", curveFit)
	.nlines(2)
	.lineFun(function(i, x){
		var drug, sample;
		var rowSample = selRowId.split("/")[0],
			rowDrug = selRowId.split("/")[1],
			colSample = selColId.split("/")[0],
			colDrug = selColId.split("/")[1];

		if(i == 0) {
			drug = rowDrug;
			sample = rowSample;
		}
		if(i == 1){ 
			drug = colDrug;
			sample = colSample;
		}
		return curveFunction(sample, drug, selectedDrug, x)
	})
	.lineStyle(function(i){
		if(i == 0) return "stroke: red;";
		if(i == 1) return "stroke: blue;";
	});
curveFit.place("#curveFit");

d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 8)
	.attr("fill", "red");
d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 24)
	.attr("fill", "blue");
d3.select("#curveFitLegend")
	.append("text")
	.attr("id", "row")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 15);
d3.select("#curveFitLegend")
	.append("text")
	.attr("id", "col")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 31);

setNames();
</script>

</body></html>