<html>

<title>Linked charts with D3</title>
<link rel="stylesheet" type="text/css" href="../src/style.css">

<body>
<div id = "selectData" style = "float: left">
	Colour by:<br>
	Screen: <select id = "screen"></select><br>
	Drug: <select id = "drug"></select> <br>
	Colour range from <input type = "number" id = "clRangeMin" 
		value = 0 style = "width: 50px">
	to <input type = "number" id = "clRangeMax" value = 15 
		style = "width: 50px"><br>
	<button onclick = "change()">Reset</button>
</div>
<div id = "filterData" style = "margin-left: 300px">
	Filter by <br>
	screen: <select id = "screen_filter"></select><br>
	drug: <select id = "drug_filter"></select><br>
	Show only drugs <br>
	with deltaDSS at least <input type = "number" id = "dss_threshold" value = 3> <br>
	for at least <input type = "number" id = "min_cell_lines" value = 2> samples<br>
	<button onclick = "change()">Reset</button>
</div>
<table>
	<tr>
		<td><div id = "heatmap"></div></td>
		<td>
			<p id = "headline"></p>
			<div id = "curveFit"></div>
		</td>
	</tr>
</table>

<script src = "https://d3js.org/d3.v4.min.js"></script>
<script src = "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src = "https://d3js.org/d3-color.v1.min.js"></script>
<script src = "input_BigAMLData.js"></script>
<script src = "../build/d3-linked-charts.js"></script>

<script>

inputData = d3.separateBy(inputData, ["screen", "mainDrug", "sample", "DRUG_NAME"]);

//calculate deltaDSS
for(var scr in inputData)
	for(var mdr in inputData[scr])
		if(mdr != "Ctrl")
			for(var s in inputData[scr][mdr])
				for(var dr in inputData[scr][mdr][s])
					inputData[scr][mdr][s][dr].deltaDSS = 
						inputData[scr][mdr][s][dr].DSS - inputData[scr]["Ctrl"][s][dr].DSS;

var screens = Object.keys(inputData),
	mDrugs = Object.keys(inputData[screens[0]]),
	samples = Object.keys(inputData[screens[0]][mDrugs[0]]),
	drugs = Object.keys(inputData[screens[0]][mDrugs[0]][samples[0]]);
mDrugs.splice(mDrugs.indexOf("Ctrl"), 1)

//add options to all the dropdown lists
d3.select("#screen").selectAll("option")
	.data(screens)
	.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;})		
updateDrugList = function(){
	var selected_screen = document.getElementById("screen")
		.options[document.getElementById("screen").selectedIndex].value;
	var options = d3.select("#drug").selectAll("option")
		.data(mDrugs);
	options.exit().remove();
	options.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;});
}
updateDrugList();

d3.select("#screen_filter").selectAll("option")
	.data(screens)
	.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;})
updateDrugFilterList = function(){
	var selected_screen = document.getElementById("screen_filter")
		.options[document.getElementById("screen_filter").selectedIndex].value;
	var options = d3.select("#drug_filter").selectAll("option")
		.data(mDrugs);
	options.exit().remove();
	options.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;});
}
updateDrugFilterList();

//get functions
get_data = function(i, j){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		if(inputData[screen][drug][j] && inputData[screen][drug][j][i]){
			return inputData[screen][drug][j][i].deltaDSS
		} else {
			return "NaN";
		}
}
get_rowIds = function(){
	var screen = document.getElementById("screen_filter")
			.options[document.getElementById("screen_filter").selectedIndex].value,
		drug = document.getElementById("drug_filter")
			.options[document.getElementById("drug_filter").selectedIndex].value,
		min_lines = document.getElementById("min_cell_lines").value,
		thr = document.getElementById("dss_threshold").value,
		ids = [], k;
	
	for(var i = 0; i < drugs.length; i++){
		k = 0;
		for(var j in inputData[screen][drug])
			if(inputData[screen][drug][j][drugs[i]] && 
					inputData[screen][drug][j][drugs[i]].deltaDSS > thr)
				k++;
		if(k >= min_lines)
			ids.push(drugs[i]);
		}
	return ids;
}

get_colIds = function(){
	var screen = document.getElementById("screen_filter")
			.options[document.getElementById("screen_filter").selectedIndex].value,
		drug = document.getElementById("drug_filter")
			.options[document.getElementById("drug_filter").selectedIndex].value;

	return Object.keys(inputData[screen][drug]);
}
get_nrow = function(){
	return this.get_rowIds().length;
}
get_ncol = function(){
	return this.get_colIds().length;
}

get_heatmap_row = function(id){
	return this.get_rowIds().indexOf(id);
}
get_heatmap_col = function(id){
	return this.get_colIds().indexOf(id);
}

get_colourRange = function(){
	return [document.getElementById("clRangeMin").value * 1,
		 document.getElementById("clRangeMax").value * 1];
}

get_x = function(i){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
	if(i < 5)
		return Math.log10(inputData[screen][drug][selectedSample][selectedDrug]["Min.Conc.tested"] * 
						Math.pow(10, i))
	else 
		return Math.log10(inputData[screen]["Ctrl"][selectedSample][selectedDrug]["Min.Conc.tested"] * 
						Math.pow(10, i - 5));
}
get_y = function(i){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
	if(i < 5)
		return inputData[screen][drug][selectedSample][selectedDrug]["D" + (i + 1)]
	else
		return inputData[screen]["Ctrl"][selectedSample][selectedDrug]["D" + (i - 4)];
}
curveFunction = function(id, x) {
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		if(id == 0){
			var max = inputData[screen][drug][selectedSample][selectedDrug].MAX,
				min = inputData[screen][drug][selectedSample][selectedDrug].MIN,
				IC50 = inputData[screen][drug][selectedSample][selectedDrug].IC50,
				slope = inputData[screen][drug][selectedSample][selectedDrug].SLOPE;
		} else {
			var max = inputData[screen]["Ctrl"][selectedSample][selectedDrug].MAX,
				min = inputData[screen]["Ctrl"][selectedSample][selectedDrug].MIN,
				IC50 = inputData[screen]["Ctrl"][selectedSample][selectedDrug].IC50,
				slope = inputData[screen]["Ctrl"][selectedSample][selectedDrug].SLOPE;
		}
		
		return min + (max - min)/(1 + Math.pow(10, -(x - Math.log10(IC50)) * slope))
}

var selectedSample = samples[0],
	selectedDrug = drugs[0];

//create a heatmap
var chart = d3.tableChartBase()
	.nrows(get_nrow)
	.ncols(get_ncol)
	.rowIds(d3.cache(get_rowIds))
	.colIds(get_colIds)
	.heatmapRow(get_heatmap_row)
	.heatmapCol(get_heatmap_col)
	.width(500)
	.height(700)
	.margin({top: 100, bottom: 50, left: 150, right: 20});
d3.heatmapChart("heatm", chart)
	.colourRange(get_colourRange)
	.on_click(function(rowId, colId){
		selectedDrug = rowId;
		selectedSample = colId;
		curveFit.update();
		changeTitle();
	})
	.value(get_data)
	.mode("svg");

	chart.place("#heatmap");
	
//create curveFit
var curveFit = d3.axisChartBase()
	.labelX("Concentration (log10)")
	.labelY("Inhibition")
	.domainY([-20, 100]);
d3.scatterChart("scatter", curveFit)	
	.npoints(10)
	.x(get_x)
	.y(get_y)
	.style(function(i) {
		if(i < 5)
			return "fill: blue;"
		else
			return "fill: LightBlue;";
	});
d3.lineChart("line", curveFit)
	.nlines(2)
	.lineFun(curveFunction)
	.lineStyle(function(i){
		if(i == 0)
			return "stroke: blue"
		else
			return "stroke: LightBlue; stroke-dasharray: 5,5";
		});
curveFit.place("#curveFit");

change = function(){
	chart.get_rowIds("clear");
	chart.update();
	curveFit.update();
	changeTitle();
}

changeTitle = function() {
		var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		d3.select("#headline")
			.text(screen + " " + drug + " " + selectedDrug + "/" + selectedSample);
};

changeTitle();

d3.selectAll("select")
	.attr("onchange", "change()");

</script>

</body></html>