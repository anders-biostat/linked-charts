<html>

<title>Linked charts with D3</title>
<link rel="stylesheet" type="text/css" href="../src/style.css">
<script src = "https://d3js.org/d3.v4.min.js"></script>
<script src = "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src = "https://d3js.org/d3-color.v1.min.js"></script>
<script src = "input_AMLData.js"></script>
<script src = "../build/d3-linked-charts.js"></script>

<body>
<table>
	<tr>
		<td>
			<h4 id = "mainScatterTitle" align = "center"></h4>
			<div id = "mainScatter"></div>
			<table>
				<tr>
					<td>
						<input type = "radio" value = "CTG" name = "screen" onchange = "switchScatter();" checked>CTG<br>
						<input type = "radio" value = "CTxG"  name = "screen" onchange = "switchScatter();">CTxG
					</td>
					<td>
						<input type = "radio" value = "DSS" name = "type" onchange = "switchScatter();" checked>DSS<br>
						<input type = "radio" value = "avInh"  name = "type" onchange = "switchScatter();">Average inhibition
					</td>
					<td>
						x Axis:
						<select id = "xList" onchange = "switchScatter();">
							<script>
								for(var i = 0; i < Object.keys(inputData.CTG).length; i++)
									document.write("<option value=\"" + Object.keys(inputData.CTG)[i] + "\">" + Object.keys(inputData.CTG)[i] + "</option>\n");
							</script>				
						</select> <br>
						y Axis:
						<select id = "yList" onchange = "switchScatter();">
							<script>
								for(var i = 0; i < Object.keys(inputData.CTG).length; i++)
									document.write("<option value=\"" + Object.keys(inputData.CTG)[i] + "\">" + Object.keys(inputData.CTG)[i] + "</option>\n");
								d3.select("#yList").property("selectedIndex", 1).node().focus();
							</script>				
						</select> <br>
					</td>
				</tr>
			</table>
		</td>
		<td>
		<h4 id = "curveFitTitle" align = "center"></h4>
		<div id = "curveFit"></div>
		<svg id = "curveFitLegend"></svg>
		</td>
	</tr>
</table>


<script>

function curveFunction (mainDrug, drug, x) {
	var max = inputData[screen][mainDrug][drug].max,
		min = inputData[screen][mainDrug][drug].min,
		IC50 = inputData[screen][mainDrug][drug].IC50,
		slope = inputData[screen][mainDrug][drug].Slope;
		
		return min + (max - min)/(1 + Math.pow(10, -(x - Math.log10(IC50)) * slope))
}

var screen = "CTG", type = "DSS";
var xAxis = document.getElementById("xList").value, 
	yAxis = document.getElementById("yList").value;

d3.select("#mainScatterTitle")
	.text(screen + ": " + xAxis + " vs. " + yAxis + " (" + type + ")");

function switchScatter() {
	var radios = document.getElementsByName('screen');
	radios[0].checked ? screen = "CTG" : screen = "CTxG";
	radios = document.getElementsByName('type');
	radios[0].checked ? type = "DSS" : type = "avInh";
	xAxis = document.getElementById("xList").value, 
	yAxis = document.getElementById("yList").value;
	d3.select("#mainScatterTitle")
		.text(screen + ": " + xAxis + " vs. " + yAxis + " (" + type + ")");
	scatter.update();
	curveFit.update();
}

var colorScale = d3.scaleLinear()
	.range([0, 1])
	.domain([0, 25]);	

function get_residuals(id, mainDrug){
	res = 0;
	minConc = inputData[screen][mainDrug][id].minConc;
	for(var k = 1; k <= 5; k++){
		res += Math.pow(curveFunction(mainDrug, id, Math.log10(minConc * Math.pow(10, k - 1))) - 
							inputData[screen][mainDrug][id]["D" + k], 2);
	}
	res = Math.sqrt(res);
	return res;
}

var selectedDrug = Object.keys(inputData.CTG.Ctrl)[0];
d3.select("#curveFitTitle")
	.text(selectedDrug);

var scatter = d3.scatterChart()
	.x(function(id) {
		return inputData[screen][xAxis][id][type];
	})
	.y(function(id){
		return inputData[screen][yAxis][id][type];
	})
	.dataIds(function(){
		return Object.keys(inputData[screen][xAxis]);
	})
	.labelX(function() {return xAxis})
	.labelY(function() {return yAxis})
	.colour(function(id){
		var res = (get_residuals(id, xAxis) + get_residuals(id, yAxis))/2;
		return "rgb(" + Math.round(Math.pow(colorScale(res), 3) * 255) + ", " +  
							Math.round(80 + Math.pow((1 - colorScale(res)), 3) * 150) + "," + 
							Math.round(Math.pow(1 - colorScale(res), 3) * 150) + ")";

	})
	.size(5)
	.on_click(function(id){
		selectedDrug = id;
		curveFit.update();
		d3.select("#curveFitTitle")
			.text(selectedDrug);
	})
	.place("#mainScatter");

var curveFit = d3.axisChartBase()
	.height(300)
	.labelX("Concentration (log10)")
	.labelY("Inhibition")
	.domainY([-20, 100]);
d3.scatterChart("scatter", curveFit)	
	.npoints(20)
	.x(function(i){
		var x;
		if(Math.abs(2 - i) <= 2){
			x = inputData[screen]["Ctrl"][selectedDrug].minConc * Math.pow(10, i);
		}
		if(Math.abs(7 - i) <= 2){
			x = inputData[screen]["Glasdegib"][selectedDrug].minConc * Math.pow(10, i - 5);
		}
		if(Math.abs(12 - i) <= 2){
			x = inputData[screen]["LY200"][selectedDrug].minConc * Math.pow(10, i - 10);
		}
		if(Math.abs(17 - i) <= 2){
			x = inputData[screen]["LY1000"][selectedDrug].minConc * Math.pow(10, i - 15);
		}
		return Math.log10(x);
	})
	.y(function(i){
		if(Math.abs(2 - i) <= 2){
			return inputData[screen]["Ctrl"][selectedDrug]["D" + (i + 1)];
		}
		if(Math.abs(7 - i) <= 2){
			return inputData[screen]["Glasdegib"][selectedDrug]["D" + (i - 4)];
		}
		if(Math.abs(12 - i) <= 2){
			return inputData[screen]["LY200"][selectedDrug]["D" + (i - 9)];
		}
		if(Math.abs(17 - i) <= 2){
			return inputData[screen]["LY1000"][selectedDrug]["D" + (i - 14)];
		}
	})
	.colour(function(i){
		if(Math.abs(2 - i) <= 2){
			return "#aaa";
		}
		if(Math.abs(7 - i) <= 2){
			return "green";
		}
		if(Math.abs(12 - i) <= 2){
			return "LightBlue";
		}
		if(Math.abs(17 - i) <= 2){
			return "blue";
		}
	});
d3.lineChart("line", curveFit)
	.nlines(4)
	.lineFun(function(i, x){
		var mainDrug;
		if(i == 0) mainDrug = "Ctrl";
		if(i == 1) mainDrug = "Glasdegib";
		if(i == 2) mainDrug = "LY200";
		if(i == 3) mainDrug = "LY1000";

		return curveFunction(mainDrug, selectedDrug, x)
	})
	.lineStyle(function(i){
		if(i == 0) return "stroke: #aaa;";
		if(i == 1) return "stroke: green;";
		if(i == 2) return "stroke: LightBlue;";
		if(i == 3) return "stroke: blue";
	});
curveFit.place("#curveFit");


d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 8)
	.attr("fill", "#aaa");
d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 24)
	.attr("fill", "green");
d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 40)
	.attr("fill", "LightBlue");
d3.select("#curveFitLegend")
	.append("circle")
	.attr("r", 7)
	.attr("cx", 45)
	.attr("cy", 56)
	.attr("fill", "blue");
d3.select("#curveFitLegend")
	.append("text")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 15)
	.text("Ctrl");
d3.select("#curveFitLegend")
	.append("text")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 31)
	.text("Glasdegib");
d3.select("#curveFitLegend")
	.append("text")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 47)
	.text("LY200");	
d3.select("#curveFitLegend")
	.append("text")
	.attr("font-size", 14)
	.attr("dx", 54)
	.attr("dy", 63)
	.text("LY1000");
</script>

</body></html>