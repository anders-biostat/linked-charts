<!--Based on the example from https://igv.org/web/release/2.2.2/examples/localBam.html -->
<head>
    <title>IGV - Local Bam</title>
    <script src="https://cdn.jsdelivr.net/npm/igv@2.15.5/dist/igv.min.js"></script>
</head>

<body>
<div id="linked-charts">
    <table><tr>
        <td id="A1"></td>
        <td id="A2"></td>
    </tr></table>
</div>
<div>
    <p>
        <label>BAM file and index
            <input id="fileWidget" type="file" multiple="true" accept=".bam,.bai" onchange="load()"/>
        </label>
    </p>
</div>

<div id="myDiv" style="padding-top: 50px;padding-bottom: 20px; border-style: inset; height: auto">
</div>


<script type="text/javascript">

    var igvBrowser;

    document.addEventListener("DOMContentLoaded", function () {

        var div = document.getElementById("myDiv");
        var options = {
            locus: "TSPAN6",       // OPTIONAL, open at a specific location
            genome: "hg38"
        };
        igv.createBrowser(div, options)
            .then(function (b) {
                igvBrowser = b;
            })
    })

    function load() {

        var fileWidget = document.getElementById("fileWidget");
        var files = fileWidget.files;

        // Find BAM files and cache index files.  Note there are 2 index naming conventions, .bam.bai and .bai
        // This scheme catches both.
        var bamFiles = [];
        var indexFiles = {};

        for (let file of files) {
            if (file.name.endsWith(".bam")) {
                bamFiles.push(file);
            }
            else if (file.name.endsWith(".bai")) {
                var key = getKey(file.name);
                indexFiles[key] = file;
            }
            else {
                alert("Unsupported file type: " + file.name);
            }
        }

        // Create track objects
        var trackConfigs = [];

        for (let file of bamFiles) {

            var key = getKey(file.name);
            var indexFile = indexFiles[key];
            if (indexFile) {
                trackConfigs.push({
                    name: file.name,
                    type: "alignment",
                    format: "bam",
                    height: 150,
                    url: file,
                    indexURL: indexFile
                })
            }
            else {
                alert("No index file for: " + file.name);
            }
        }

        if (trackConfigs.length > 0) {
            igvBrowser.loadTrackList(trackConfigs);
        }


        function getKey(filename) {
            var idx = filename.indexOf(".");
            if (idx < 0) {
                console.error("File with no extension: " + filename);
            }
            else {
                return filename.substring(0, idx);
            }

        }
    }
</script>
</body>
