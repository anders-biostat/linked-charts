<html>

<title>Linked charts with D3</title>
<link rel="stylesheet" type="text/css" href="../src/style.css">

<body>
<table><tr>
	<td>
		<div id = "heatmap" style = "max-height: 700px; overflow-y: scroll;"></div>
		<div id = "redSlider"></div>
		<div id = "greenSlider"></div>
	</td>
	<td>
		<table><tr>
			<td>
				Show samples:<br>
				<div id = "samples"></div>
			</td>
			<td>
				Show drugs: <br>
				<div id = "drugs"></div>
			</td>
		</tr></table>
		Show only drugs <br>
			with deltaDSS at least <input type = "number" id = "dss_threshold" value = 5> <br>
			for at least <input type = "number" id = "min_cell_lines" value = 2> samples<br>
		<br>
		What to use as a control?<br>
		<input type = "radio" value = "Ctrl" name = "ctrl" onchange = "changeCtrl();" checked>Ctrl<br>
		<input type = "radio" value = "FO4B"  name = "ctrl" onchange = "changeCtrl();">FO4B
	</td>
</tr></table>

<script src = "https://d3js.org/d3.v4.min.js"></script>
<script src = "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src = "https://d3js.org/d3-color.v1.min.js"></script>
<script src = "input_BigAMLData.js"></script>
<script src = "../src/lib/clusterfck.js"></script>
<script src = "../build/d3-linked-charts.js"></script>

<script>

//Get a set of drugnames
var drugs = [];
for(var i = 0; i < inputData.length; i++){
	if(drugs.indexOf(inputData[i].DRUG_NAME) == -1)
		drugs.push(inputData[i].DRUG_NAME);
}
//Get a set of samplenames
var samples = [];
for(var i = 0; i < inputData.length; i++){
	if(samples.indexOf(inputData[i].sample) == -1)
		samples.push(inputData[i].sample);
}
//Get a set of main drugs
var mainDrugs = [];
for(var i = 0; i < inputData.length; i++){
	if(mainDrugs.indexOf(inputData[i].mainDrug) == -1)
		mainDrugs.push(inputData[i].mainDrug);
}
samples = samples.sort();
drugs = drugs.sort();
mainDrugs = mainDrugs.sort();
var markedDrugs = drugs.slice();
var ctrl = "Ctrl";

inputData = d3.separateBy(inputData, ["screen", "sample", "mainDrug", "DRUG_NAME"]);

//add drug checkboxes
var chB = d3.select("#drugs").selectAll("input")
	.data(mainDrugs).enter().append("div")
		.attr("id", function(d) {return d;});
chB.append("input")
	.attr("type", "checkbox")
	.attr("id", function(d) {return d;})
	.attr("checked", true)
	.attr("onchange", "switchHeatmap();");
chB.append("label")
	.attr("for", function(d) {return d;})
	.text(function(d) {return d;});
//add sample checkboxes
var chB = d3.select("#samples").selectAll("input")
	.data(samples).enter().append("div");
chB.append("input")
	.attr("type", "checkbox")
	.attr("id", function(d) {return d;})
	.attr("checked", true)
	.attr("onchange", "switchHeatmap();");
chB.append("label")
	.attr("for", function(d) {return d;})
	.text(function(d) {return d;});


//uncheck and hide Ctrl
d3.select("#drugs").select("#" + ctrl)
	.classed("hidden", true)
	.select("input")
		.attr("checked", null);

function changeCtrl(){
	d3.select("#drugs").select("#" + ctrl)
		.classed("hidden", false)
		.select("input")
			.attr("checked", true);

	var radios = document.getElementsByName('ctrl');
	radios[0].checked ? ctrl = "Ctrl" : ctrl = "FO4B";	

	d3.select("#drugs").select("#" + ctrl)
		.classed("hidden", true)
		.select("input")
			.attr("checked", null);

	heatmap.get_rowIds("clear");
	heatmap.get_colIds("clear");
	width = get_colIds().length * cellSize, 
	height = get_rowIds().length * cellSize;
	heatmap.width(width)
		.height(height)
		.update();
}

function switchHeatmap(){

}

get_colIds = function(){
	var selSamples = d3.select("#samples").selectAll("input")
		.filter(function() {return this.checked;})
		.data();
	
	var selDrugs = d3.select("#drugs").selectAll("input")
		.filter(function() {return this.checked;})
		.data();

	var selIds = [];
	for(var i = 0; i < selSamples.length; i++)
		for(var j = 0; j < selDrugs.length; j++)
			if(inputData["CTG"][selSamples[i]][selDrugs[j]] && 
				inputData["CTG"][selSamples[i]][ctrl])
				selIds.push(selSamples[i] + "/" + selDrugs[j]); 

	return selIds;
}

get_rowIds = function(){
	var min_lines = document.getElementById("min_cell_lines").value,
		thr = document.getElementById("dss_threshold").value,
		ids = [], k;
	
	for(var i = 0; i <= drugs.length; i++)
	{
		k = 0;
		for(var j in inputData)
			for(var s in inputData[j])
				if(inputData[j][s][ctrl])
					for(var d in inputData[j][s])
						if(inputData[j][s][d][drugs[i]] && inputData[j][s][ctrl][drugs[i]])
							if(inputData[j][s][d][drugs[i]].DSS - 
								inputData[j][s][ctrl][drugs[i]].DSS > thr) k++;

		if(k >= min_lines)
			ids.push(drugs[i])
	}

	return ids;
}

var clusterMetric = function(a, b) {
	var sum = 0;
	for(var i = 0; i < a.length; i++){
		sum += (a[i][0] - b[i][0]) * (a[i][0] - b[i][0]) +
					(a[i][1] - b[i][1]) * (a[i][1] - b[i][1]);
	return Math.sqrt(sum);
	}
}

var redSlider = d3.sigmoidColorSlider()
	.straightColorScale( d3.scaleLinear().range( [ "black", "red" ] ).domain([0, 15]) )
  .place("#redSlider");
var greenSlider = d3.sigmoidColorSlider()
	.straightColorScale( d3.scaleLinear().range( [ "black", "green" ] ).domain([0, 15]) )
  .place("#greenSlider");

var cellSize = 15, 
	width = get_colIds().length * cellSize, 
	height = get_rowIds().length * cellSize;

var heatmap = d3.tableChartBase()
	.width(width)
	.height(height)
	.margin({top: 100, bottom: 20, left: 150, right: 20})
	.rowIds(d3.cache(get_rowIds))
	.colIds(d3.cache(get_colIds));
	
d3.heatmapChart("main", heatmap)
	.mode("svg")
	.value(function(rowId, colId){
		var ids = colId.split("/");
		if(typeof inputData.CTG[ids[0]][ids[1]][rowId] !== "undefined" &&
			typeof inputData.CTG[ids[0]][ctrl][rowId] !== "undefined"){
				return [inputData.CTG[ids[0]][ids[1]][rowId].DSS - inputData.CTG[ids[0]][ctrl][rowId].DSS,
					inputData.CTxG[ids[0]][ids[1]][rowId].DSS - inputData.CTxG[ids[0]][ctrl][rowId].DSS]
		} else {
			return [0, 0];
		}
	})
	.colour(function(val){
		return "rgb(" + Math.round(redSlider.the_sigmoid(val[1]) * 255) + ", " 
			+ Math.round(greenSlider.the_sigmoid(val[0]) * 255) + ", 15)";
	})
	.colourRange([0, 15])
	.clusterRowsMetric(clusterMetric)
	.clusterColsMetric(clusterMetric);
heatmap.place("#heatmap");

var layer = heatmap.get_layer("main");
layer.clusterRows();
layer.clusterCols();

//define what happens when sliders are used
redSlider.last_dispatch = -Infinity
redSlider.on_change( function() {
	var currentTime = new Date();
  if( currentTime - redSlider.last_dispatch > 300 ) {
	  redSlider.last_dispatch = new Date();
		//heatmap.get_layer("main").updateCanvas();
    heatmap.get_layer("main").updateColour(); 
	}
});
greenSlider.last_dispatch = -Infinity
greenSlider.on_change( function() {
	var currentTime = new Date();
  if( currentTime - greenSlider.last_dispatch > 300 ) {
	  greenSlider.last_dispatch = new Date();
		//heatmap.get_layer("main").updateCanvas();
    heatmap.get_layer("main").updateColour(); 
	}
});



</script>

</body></html>