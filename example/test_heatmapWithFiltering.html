<html>

<title>Linked charts with D3</title>
<link rel="stylesheet" type="text/css" href="../src/style.css">

<body>
<div id = "selectData" style = "float: left">
	Colour by:<br>
	Screen: <select id = "screen"></select><br>
	Drug: <select id = "drug"></select> <br>
	Colour range from <input type = "number" id = "clRangeMin" 
		value = 0 style = "width: 50px">
	to <input type = "number" id = "clRangeMax" value = 15 
		style = "width: 50px"><br>
	<button onclick = "change()">Reset</button>
</div>
<div id = "filterData" style = "margin-left: 300px">
	Filter by <br>
	screen: <select id = "screen_filter"></select><br>
	drug: <select id = "drug_filter"></select><br>
	Show only drugs <br>
	with deltaDSS at least <input type = "number" id = "dss_threshold" value = 5> <br>
	for at least <input type = "number" id = "min_cell_lines" value = 2> cell lines<br>
	<button onclick = "change()">Reset</button>
</div>
<table>
	<tr>
		<td><div id = "heatmap"></div></td>
		<td>
			<p id = "headline"></p>
			<div id = "curveFit"></div>
		</td>
	</tr>
</table>

<script src = "https://d3js.org/d3.v4.min.js"></script>
<script src = "https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src = "https://d3js.org/d3-color.v1.min.js"></script>
<script src = "input_heatmapWithFiltering.js"></script>
<script src = "../build/d3-linked-charts.js"></script>

<script>
//add options to all the dropdown lists
d3.select("#screen").selectAll("option")
	.data(Object.keys(inputData))
	.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;})		
updateDrugList = function(){
	var selected_screen = document.getElementById("screen")
		.options[document.getElementById("screen").selectedIndex].value;
	var options = d3.select("#drug").selectAll("option")
		.data(Object.keys(inputData[selected_screen]));
	options.exit().remove();
	options.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;});
}
updateDrugList();

d3.select("#screen_filter").selectAll("option")
	.data(Object.keys(inputData))
	.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;})
updateDrugFilterList = function(){
	var selected_screen = document.getElementById("screen_filter")
		.options[document.getElementById("screen_filter").selectedIndex].value;
	var options = d3.select("#drug_filter").selectAll("option")
		.data(Object.keys(inputData[selected_screen]));
	options.exit().remove();
	options.enter().append("option")
		.attr("value", function(d) {return d;})
		.text(function(d) {return d;});
}
updateDrugFilterList();

//get functions
get_data = function(i, j){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		return inputData[screen][drug]["dss"][i][j];
}
get_rowIds = function(){
	var screen = document.getElementById("screen_filter")
			.options[document.getElementById("screen_filter").selectedIndex].value,
		drug = document.getElementById("drug_filter")
			.options[document.getElementById("drug_filter").selectedIndex].value,
		min_lines = document.getElementById("min_cell_lines").value,
		thr = document.getElementById("dss_threshold").value,
		ids = [], k;
	
	for(var i in inputData[screen][drug].dss){
		k = 0;
		for(var j in inputData[screen][drug]["dss"][i])
			if(inputData[screen][drug]["dss"][i][j] > thr)
				k++;
		if(k >= min_lines)
			ids.push(i);
		}
	return ids;
}

get_colIds = function(){
	var screen = document.getElementById("screen_filter")
			.options[document.getElementById("screen_filter").selectedIndex].value,
		drug = document.getElementById("drug_filter")
			.options[document.getElementById("drug_filter").selectedIndex].value,
		row_name = Object.keys(inputData[screen][drug]["dss"])[0];

	return Object.keys(inputData[screen][drug]["dss"][row_name]);
}
get_nrow = function(){
	return this.get_rowIds().length;
}
get_ncol = function(){
	return this.get_colIds().length;
}

get_heatmap_row = function(id){
	return this.get_rowIds().indexOf(id);
}
get_heatmap_col = function(id){
	return this.get_colIds().indexOf(id);
}

get_colourRange = function(){
	return [document.getElementById("clRangeMin").value * 1,
		 document.getElementById("clRangeMax").value * 1];
}

get_x = function(i){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
	if(i < 5)
		return Math.log10(inputData[screen][drug]["curveFit"][curveFit_id].minConc * 
						Math.pow(10, i))
	else 
		return Math.log10(inputData[screen]["DMSO"]["curveFit"][curveFit_id].minConc * 
						Math.pow(10, i - 5));
}
get_y = function(i){
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
	if(i < 5)
		return inputData[screen][drug]["curveFit"][curveFit_id]["D" + (i + 1)]
	else
		return inputData[screen]["DMSO"]["curveFit"][curveFit_id]["D" + (i - 4)];
}
curveFunction = function(id, x) {
	var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		if(id == 0){
			var max = inputData[screen][drug]["curveFit"][curveFit_id].max,
				min = inputData[screen][drug]["curveFit"][curveFit_id].min,
				IC50 = inputData[screen][drug]["curveFit"][curveFit_id].IC50,
				slope = inputData[screen][drug]["curveFit"][curveFit_id].Slope;
		} else {
			var max = inputData[screen]["DMSO"]["curveFit"][curveFit_id].max,
				min = inputData[screen]["DMSO"]["curveFit"][curveFit_id].min,
				IC50 = inputData[screen]["DMSO"]["curveFit"][curveFit_id].IC50,
				slope = inputData[screen]["DMSO"]["curveFit"][curveFit_id].Slope;
		}
		
		return min + (max - min)/(1 + Math.pow(10, -(x - Math.log10(IC50)) * slope))
}


var curveFit_id = Object.keys(inputData.ctx.Alpelisib.curveFit)[0];

//create a heatmap
var chart = d3.tableChartBase()
	.nrows(get_nrow)
	.ncols(get_ncol)
	.rowIds(d3.cache(get_rowIds))
	.colIds(get_colIds)
	.heatmapRow(get_heatmap_row)
	.heatmapCol(get_heatmap_col)
	.width(1000)
	.height(700)
	.margin({top: 100, bottom: 50, left: 150, right: 20});
d3.heatmapChart("heatm", chart)
	.colourRange(get_colourRange)
	.on_click(function(d){
		curveFit_id = d[1] + "_" + d[0];
		curveFit.update();
		changeTitle();
	})
	.value(get_data)
	.mode("svg");

	chart.place("#heatmap");
	
//create curveFit
var curveFit = d3.axisChartBase()
	.labelX("Concentration (log10)")
	.labelY("Inhibition");
d3.scatterChart("scatter", curveFit)	
	.npoints(10)
	.x(get_x)
	.y(get_y)
	.style(function(i) {
		if(i < 5)
			return "fill: blue;"
		else
			return "fill: LightBlue;";
	});
d3.lineChart("line", curveFit)
	.nlines(2)
	.lineFun(curveFunction)
	.lineStyle(function(i){
		if(i == 0)
			return "stroke: blue"
		else
			return "stroke: LightBlue; stroke-dasharray: 5,5";
		});
curveFit.place("#curveFit");

change = function(){
	chart.update();
	curveFit.update();
	changeTitle();
}

changeTitle = function() {
		var screen = document.getElementById("screen")
			.options[document.getElementById("screen").selectedIndex].value,
		drug = document.getElementById("drug")
			.options[document.getElementById("drug").selectedIndex].value;
		d3.select("#headline")
			.text(screen + " " + drug + " " + curveFit_id);
};

changeTitle();

d3.selectAll("select")
	.attr("onchange", "change()");

</script>

</body></html>