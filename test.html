<html><title>Linked charts with D3</title>

<body>

<div id="main_scatter_plot"></div>
<p id="extra_info"></p>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
data = JSON.parse( '[{"mpg":21,"cyl":6,"disp":160,"hp":110,"drat":3.9,"wt":2.62,"qsec":16.46,"vs":0,"am":1,"gear":4,"carb":4,"_row":"Mazda RX4"},{"mpg":21,"cyl":6,"disp":160,"hp":110,"drat":3.9,"wt":2.875,"qsec":17.02,"vs":0,"am":1,"gear":4,"carb":4,"_row":"Mazda RX4 Wag"},{"mpg":22.8,"cyl":4,"disp":108,"hp":93,"drat":3.85,"wt":2.32,"qsec":18.61,"vs":1,"am":1,"gear":4,"carb":1,"_row":"Datsun 710"},{"mpg":21.4,"cyl":6,"disp":258,"hp":110,"drat":3.08,"wt":3.215,"qsec":19.44,"vs":1,"am":0,"gear":3,"carb":1,"_row":"Hornet 4 Drive"},{"mpg":18.7,"cyl":8,"disp":360,"hp":175,"drat":3.15,"wt":3.44,"qsec":17.02,"vs":0,"am":0,"gear":3,"carb":2,"_row":"Hornet Sportabout"},{"mpg":18.1,"cyl":6,"disp":225,"hp":105,"drat":2.76,"wt":3.46,"qsec":20.22,"vs":1,"am":0,"gear":3,"carb":1,"_row":"Valiant"},{"mpg":14.3,"cyl":8,"disp":360,"hp":245,"drat":3.21,"wt":3.57,"qsec":15.84,"vs":0,"am":0,"gear":3,"carb":4,"_row":"Duster 360"},{"mpg":24.4,"cyl":4,"disp":146.7,"hp":62,"drat":3.69,"wt":3.19,"qsec":20,"vs":1,"am":0,"gear":4,"carb":2,"_row":"Merc 240D"},{"mpg":22.8,"cyl":4,"disp":140.8,"hp":95,"drat":3.92,"wt":3.15,"qsec":22.9,"vs":1,"am":0,"gear":4,"carb":2,"_row":"Merc 230"},{"mpg":19.2,"cyl":6,"disp":167.6,"hp":123,"drat":3.92,"wt":3.44,"qsec":18.3,"vs":1,"am":0,"gear":4,"carb":4,"_row":"Merc 280"},{"mpg":17.8,"cyl":6,"disp":167.6,"hp":123,"drat":3.92,"wt":3.44,"qsec":18.9,"vs":1,"am":0,"gear":4,"carb":4,"_row":"Merc 280C"},{"mpg":16.4,"cyl":8,"disp":275.8,"hp":180,"drat":3.07,"wt":4.07,"qsec":17.4,"vs":0,"am":0,"gear":3,"carb":3,"_row":"Merc 450SE"},{"mpg":17.3,"cyl":8,"disp":275.8,"hp":180,"drat":3.07,"wt":3.73,"qsec":17.6,"vs":0,"am":0,"gear":3,"carb":3,"_row":"Merc 450SL"},{"mpg":15.2,"cyl":8,"disp":275.8,"hp":180,"drat":3.07,"wt":3.78,"qsec":18,"vs":0,"am":0,"gear":3,"carb":3,"_row":"Merc 450SLC"},{"mpg":10.4,"cyl":8,"disp":472,"hp":205,"drat":2.93,"wt":5.25,"qsec":17.98,"vs":0,"am":0,"gear":3,"carb":4,"_row":"Cadillac Fleetwood"},{"mpg":10.4,"cyl":8,"disp":460,"hp":215,"drat":3,"wt":5.424,"qsec":17.82,"vs":0,"am":0,"gear":3,"carb":4,"_row":"Lincoln Continental"},{"mpg":14.7,"cyl":8,"disp":440,"hp":230,"drat":3.23,"wt":5.345,"qsec":17.42,"vs":0,"am":0,"gear":3,"carb":4,"_row":"Chrysler Imperial"},{"mpg":32.4,"cyl":4,"disp":78.7,"hp":66,"drat":4.08,"wt":2.2,"qsec":19.47,"vs":1,"am":1,"gear":4,"carb":1,"_row":"Fiat 128"},{"mpg":30.4,"cyl":4,"disp":75.7,"hp":52,"drat":4.93,"wt":1.615,"qsec":18.52,"vs":1,"am":1,"gear":4,"carb":2,"_row":"Honda Civic"},{"mpg":33.9,"cyl":4,"disp":71.1,"hp":65,"drat":4.22,"wt":1.835,"qsec":19.9,"vs":1,"am":1,"gear":4,"carb":1,"_row":"Toyota Corolla"},{"mpg":21.5,"cyl":4,"disp":120.1,"hp":97,"drat":3.7,"wt":2.465,"qsec":20.01,"vs":1,"am":0,"gear":3,"carb":1,"_row":"Toyota Corona"},{"mpg":15.5,"cyl":8,"disp":318,"hp":150,"drat":2.76,"wt":3.52,"qsec":16.87,"vs":0,"am":0,"gear":3,"carb":2,"_row":"Dodge Challenger"},{"mpg":15.2,"cyl":8,"disp":304,"hp":150,"drat":3.15,"wt":3.435,"qsec":17.3,"vs":0,"am":0,"gear":3,"carb":2,"_row":"AMC Javelin"},{"mpg":13.3,"cyl":8,"disp":350,"hp":245,"drat":3.73,"wt":3.84,"qsec":15.41,"vs":0,"am":0,"gear":3,"carb":4,"_row":"Camaro Z28"},{"mpg":19.2,"cyl":8,"disp":400,"hp":175,"drat":3.08,"wt":3.845,"qsec":17.05,"vs":0,"am":0,"gear":3,"carb":2,"_row":"Pontiac Firebird"},{"mpg":27.3,"cyl":4,"disp":79,"hp":66,"drat":4.08,"wt":1.935,"qsec":18.9,"vs":1,"am":1,"gear":4,"carb":1,"_row":"Fiat X1-9"},{"mpg":26,"cyl":4,"disp":120.3,"hp":91,"drat":4.43,"wt":2.14,"qsec":16.7,"vs":0,"am":1,"gear":5,"carb":2,"_row":"Porsche 914-2"},{"mpg":30.4,"cyl":4,"disp":95.1,"hp":113,"drat":3.77,"wt":1.513,"qsec":16.9,"vs":1,"am":1,"gear":5,"carb":2,"_row":"Lotus Europa"},{"mpg":15.8,"cyl":8,"disp":351,"hp":264,"drat":4.22,"wt":3.17,"qsec":14.5,"vs":0,"am":1,"gear":5,"carb":4,"_row":"Ford Pantera L"},{"mpg":19.7,"cyl":6,"disp":145,"hp":175,"drat":3.62,"wt":2.77,"qsec":15.5,"vs":0,"am":1,"gear":5,"carb":6,"_row":"Ferrari Dino"},{"mpg":15,"cyl":8,"disp":301,"hp":335,"drat":3.54,"wt":3.57,"qsec":14.6,"vs":0,"am":1,"gear":5,"carb":8,"_row":"Maserati Bora"},{"mpg":21.4,"cyl":4,"disp":121,"hp":109,"drat":4.11,"wt":2.78,"qsec":18.6,"vs":1,"am":1,"gear":4,"carb":2,"_row":"Volvo 142E"}]')	
</script>

<script>

// General chart class

function chartBase() {

  var obj = {};

  obj.add_property = function( propname, defaultval ) {
    var getter = "get_" + propname;
    obj[ propname ] = function( vf ) {
      if( vf === undefined )
        throw "No value passed in setter for property '" + propname + "'.";
      if( typeof(vf) === "function" )
        obj[ getter ] = vf
      else
        obj[ getter ] = function() { return vf };
      return obj
    }
    obj[ getter ] = function() { return defaultval }
    return obj;
  }

  obj
    .add_property( "width", 500 )
    .add_property( "height", 400 )
    .add_property( "margin", { top: 20, right: 10, bottom: 20, left: 10 } );

  obj.place = function( element ) {
    if( element === undefined )
      element = "body";
    if( typeof( element ) == "string" ) {
      element = d3.select( element );
      if( element.size == 0 )
        throw "Error in function 'place': DOM selection for string '" +
          node + "' did not find a node."
    }

    obj.put_static_content( element );

    obj.update();
    return obj;
  }

  obj.put_static_content = function( element ) {
    obj.real_svg = element.append( "svg" );
    obj.svg = obj.real_svg.append( "g" );
  }

  obj.update = function( ) {
    obj.real_svg
      .attr( "width", obj.get_width() 
          + obj.get_margin().left + obj.get_margin().right )
      .attr( "height", obj.get_height() 
          + obj.get_margin().top + obj.get_margin().bottom );
    obj.svg
      .attr( "transform", "translate(" + obj.get_margin().left + "," 
          + obj.get_margin().top + ")" );
    return obj;
  }

  return obj;
}

// Scatter plot class

function scatterChart() {

  var obj = chartBase()
    .add_property( "x" )
    .add_property( "y" )
    .add_property( "numPoints" )
    .add_property( "dataIds" );

  obj
    .add_property( "x_label", "" )
    .add_property( "y_label", "" )
    .add_property( "on_click", function() {} )

  // Set default margin
  obj.margin( { top: 20, right: 20, bottom: 30, left: 40 } );

  // Set default for dataIds, namely to return numbers accoring to numPoints
  obj.dataIds( function() { return d3.range( obj.get_numPoints() ) } );

  // Set default for numPoints, namely to count the data provided for x
  obj.numPoints( function() {
    var val;
    for( var i = 0; i < 10000; i++ ) {
      try {
        // try to get a value
        val = obj.get_x(i)
      } catch( exc ) {
        // if call failed with exception, report the last successful 
        // index, if any, otherwise zero
        return i > 0 ? i-1 : 0;  
      }
      if( val === undefined ) {
        // same again: return last index with defines return, if any,
        // otherwise zero
        return i > 0 ? i-1 : 0;  
      }
    }
    // If we exit the loop, there is either something wrong or there are
    // really many points
    throw "There seem to be very many data points. Please supply a number via 'numPoints'."
  })

  var inherited_put_static_content = obj.put_static_content;
  obj.put_static_content = function( element ) {
    inherited_put_static_content( element );

    obj.axes = {};

    obj.axes.x_g = obj.svg.append( "g" )
      .attr( "class", "x axis" )
      .attr( "transform", "translate(0," + obj.get_height() + ")" );
    obj.axes.x_label = obj.axes.x_g.append( "text" )
      .attr( "class", "label" )
      .attr( "fill", "black")   // why do I need this?
      .style( "text-anchor", "end" );
    obj.axes.x_axis = d3.axisBottom();

    obj.axes.y_g = obj.svg.append( "g" )
      .attr( "class", "y axis" )
    obj.axes.y_label = obj.axes.y_g.append( "text" )
      .attr( "class", "label" )
      .attr( "fill", "black")
      .attr( "transform", "rotate(-90)" )
      .style( "text-anchor", "end" );
    obj.axes.y_axis = d3.axisLeft();
  }

  var inherited_update = obj.update;
  obj.update_not_yet_called = true;
  obj.update = function() {
    inherited_update();

    var transition = d3.transition();
    if( obj.update_not_yet_called ) {
      obj.update_not_yet_called = false;
      transition.duration( 0 );
    } else
      transition.duration(1000);

    // Set scales and axes
    var scale_x = d3.scaleLinear()
      .domain( d3.extent( obj.get_dataIds(), function(k) { return obj.get_x(k) } ) )
      .range( [ 0, obj.get_width() ] )
      .nice();
    var scale_y = d3.scaleLinear()
      .domain( d3.extent( obj.get_dataIds(), function(k) { return obj.get_y(k) } ) )
      .range( [ obj.get_height(), 0 ] )
      .nice();

    obj.axes.x_axis.scale( scale_x );
    obj.axes.x_g.transition(transition)
      .call( obj.axes.x_axis );

    obj.axes.y_axis.scale( scale_y );
    obj.axes.y_g.transition(transition)
      .call( obj.axes.y_axis );

    obj.axes.x_label
      .attr( "x", obj.get_width() )
      .attr( "y", -6 )
      .text( obj.get_x_label() );

    obj.axes.y_label
      .attr( "y", 6 )
      .attr( "dy", ".71em" )
      .text( obj.get_y_label() )


    var sel = obj.svg.selectAll( "circle.datapoint" )
      .data( obj.get_dataIds() );
    sel.exit()
      .remove();  
    sel.enter().append( "circle" )
      .classed( "datapoint", true )
      .attr( "r", 3 )
    .merge( sel )
      .on( "click", obj.get_on_click )
      .transition(transition)
        .attr( "cx", function(d,i) { return scale_x( obj.get_x(d) ) } )
        .attr( "cy", function(d,i) { return scale_y( obj.get_y(d) ) } );

    return obj;
  };


  return obj;
}

// Simple Table

function simpleTable() {

  obj = {}

  obj.add_property = function( propname, defaultval ) {
    var getter = "get_" + propname;
    obj[ propname ] = function( vf ) {
      if( vf === undefined )
        throw "No value passed in setter for property '" + propname + "'.";
      if( typeof(vf) === "function" )
        obj[ getter ] = vf
      else
        obj[ getter ] = function() { return vf };
      return obj
    }
    obj[ getter ] = function() { return defaultval }
    return obj;
  }

  obj.add_property( "record", {} )

  obj.place = function( element ) {
    if( element === undefined )
      element = "body";
    if( typeof( element ) == "string" ) {
      element = d3.select( element );
      if( element.size == 0 )
        throw "Error in function 'place': DOM selection for string '" +
          node + "' did not find a node."
    }

    obj.put_static_content( element );

    obj.update();
    return obj;
  }

  obj.put_static_content = function( element ) {
    obj.table = element.append( "table" );
  }

  obj.update = function( ) {

    var sel = obj.table.selectAll( "tr" )
      .data( Object.keys( obj.get_record() ) );
    sel.exit()
      .remove();  
    sel.enter().append( "tr" )
    .merge( sel )
      .html( function(k) { return "<td>" + k + "</td><td>" 
         + obj.get_record()[k] + "</td>" } )

    return obj;
  };

  return obj;
}

// User code


if( true ) {

  // Test code 1

  var highlighted = 0;

  var sc = scatterChart()
    .x( function(i) { return data[i].wt } )
    .y( function(i) { return data[i].hp } )
    .x_label( "weight" )
    .y_label( "horsepower" )
    .place( )

  var tbl = simpleTable()
    .record( function() { return data[highlighted] } )
    .place( );

  sc.on_click( function(k) { 
    highlighted = k;
    tbl.update();
  } )

  data = data.filter( function(x) { return x.hp < 300 } )

  setTimeout( function() { sc.update() }, 2000 );

} else {

  // Test code 2

  data2 = {}
  for( var i = 0; i < data.length; i++ )
    data2[ data[i]._row ] = data[i];
  
  var sc = scatterChart()
    .dataIds( function() { return Object.keys(data2) } )
    .x( function(k) { return data2[k].wt } )
    .y( function(k) { return data2[k].hp } )
    .place( "#main_scatter_plot" )

  data2
  
}

// Not yet used:

// function cache( f ) {
//   var the_cache = {}
//   return function( arguments ) {
//     if( arguments[0] === "clear" ) {
//       the_cache = {}
//       return undefined;
//     }
//     if( !( x in keys(the_cache) ) )
//       the_cache[x] = f.apply( undefined, x );
//     return the_cache[x];
//   }
// }

</script>

</body></html>